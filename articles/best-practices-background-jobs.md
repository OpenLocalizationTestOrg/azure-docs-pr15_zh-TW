<properties
   pageTitle="背景的工作指示 |Microsoft Azure"
   description="背景上的指示任務獨立的使用者介面的執行。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="christb"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="07/21/2016"
   ms.author="masashin"/>

# <a name="background-jobs-guidance"></a>背景工作指南

[AZURE.INCLUDE [pnp-header](../includes/guidance-pnp-header-include.md)]

## <a name="overview"></a>概觀

有許多類型的應用程式要求背景亦使用者介面 (UI) 執行的工作。 範例包括批次工作、 大量處理工作，以及長程序，例如工作流程。 可以執行背景工作，而不需要使用者互動，應用程式啟動工作，然後繼續進行處理互動式使用者要求。 這可以協助最小化載入到應用程式使用者介面，可改善可用性並減少互動式回應時間。

例如，如果應用程式，才能產生的使用者上傳的影像的縮圖，可這麼做為背景的作業，並儲存至儲存空間的縮圖，完成時，不需要等候程序完成使用者。 以相同的方式，訂單的使用者可以啟動背景工作流程處理順序，雖然 UI 可讓使用者將繼續瀏覽 web 應用程式。 背景工作完成時，它可以更新已儲存的訂單資料，並傳送電子郵件給使用者，以確認順序。

當您考慮實作工作為背景的作業，主要準則是否是否可以執行工作使用者的互動而不 UI 及需要完成的工作，請等候。 需要使用者或 UI 稍待完成的工作可能不適當為背景的工作。

## <a name="types-of-background-jobs"></a>背景工作的類型

背景工作通常包含一或多個下列類型的工作︰

- 需要大量 CPU 的工作，例如數學計算或結構化模型分析。
- O-大量工作，例如執行一系列的儲存空間交易或編製索引的檔案。
- 批次工作，例如電子郵件地址] 或排程的處理夜間資料更新。
- 長時間執行工作流程，例如訂單或佈建服務和系統。
- 機密資料處理位置工作交由處理更安全的位置。 例如，您可能不想處理 web 應用程式中的機密資料。 不過，您可能會使用的圖樣，例如[閘道管理員](http://msdn.microsoft.com/library/dn589793.aspx)來傳送資料至有權存取受保護的儲存空間隔離的背景處理程序。

## <a name="triggers"></a>觸發程序

數種不同的方式就能啟動背景的工作。 他們屬於下列類別︰

- [**事件導向引動程序**](#event-driven-triggers)。 任務開始回應事件，通常是將使用者或工作流程中的步驟所採取的動作。
- [**排程導向引動程序**](#schedule-driven-triggers)。 任務會根據計時器排程叫用。 這可能是週期性的排程或指定稍後一次性叫用。

### <a name="event-driven-triggers"></a>事件導向引動程序

事件導向引動使用引動程序來啟動背景工作。 使用事件導向引動程序的範例包括︰

- UI 或另一個工作將郵件放在佇列中。 郵件包含動作發生，例如使用者訂單的相關資料。 背景工作接聽此佇列中，並偵測到的新郵件送達。 它會讀取郵件，並使用中的資料，做為背景的工作輸入。
- UI 或另一個工作會儲存或更新中儲存的值。 背景工作監視儲存空間，並會偵測的變更。 它會讀取資料，並會使用該做為背景的工作輸入。
- UI 或另一個工作進行端點，例如 HTTPS URI 或顯示為 web 服務的 API 邀請。 傳遞資料所需完成背景工作要求的一部分。 結束點或 web 服務叫用該背景工作，做為輸入使用的資料。

一般工作的事件導向引動適合範例包括處理，工作流程，傳送資訊給遠端服務、 傳送電子郵件訊息與佈建 multitenant 應用程式中的新使用者的圖像。

### <a name="schedule-driven-triggers"></a>排程導向引動程序

排程導向引動使用計時器啟動背景工作。 使用排程導向引動程序的範例包括︰

- 在應用程式中或應用程式的作業系統的一部分在本機執行計時器叫用定期背景工作。
- 計時器執行的是不同的應用程式或 Azure 排程器，例如計時器服務會傳送至定期 API 或 web 服務的要求。 API 或 web 服務叫用背景工作。
- 在另一個程序或應用程式啟動計時器會使背景工作，一次指定的時間延遲之後，或在特定時間叫用。

一般工作的排程導向引動適合範例包括批次處理常式 （例如更新相關的產品清單，根據其最近的行為的使用者）、 例行資料處理工作 （例如更新索引或產生累積的結果）、 每日的報表、 資料保留清理]，及資料一致性檢查的資料分析。

如果您使用的單一執行個體就必須執行比導向排程的工作，請注意下列任一動作︰

- 如果縮放正在執行 （例如虛擬機器上使用 Windows 排程的任務） 排程器的計算執行個體，您會有多個執行個體的排程器執行。 這些可能開始任務的多個執行的個體。
- 如果排程事件之間，超過該期間執行工作，排程器可能會在前一個仍在執行時啟動另一個工作執行個體。

## <a name="returning-results"></a>傳回結果

背景工作非同步執行中的另一個程序，或甚至在不同的位置，從 UI 或叫用背景工作的程序。 理想的情況下，背景的工作是 「 啟動和忘了 」 作業，而且他們執行進度有不會影響 UI 或呼叫程序。 這表示呼叫程序不會等待完成的工作。 因此，無法自動偵測其任務結束時。

如果您需要進行通訊呼叫表示進度或完成工作的背景工作時，您必須在此實作機制。 以下是一些範例︰

- 狀態指標值寫入存取 UI 或本機工作，可以監視或核取此值時所需的儲存空間。 背景工作必須傳回給呼叫者的其他資料可以放到相同的儲存空間。
- 建立 UI 或來電者接聽回覆佇列。 背景工作可以傳送郵件給佇列中指出狀態和完成。 背景工作必須返回來電者之間的資料可以放入郵件中。 如果您使用的 Azure 服務匯流排，您可以使用 [ **ReplyTo**和**相互關聯識別碼**] 屬性實作這項功能。 如需詳細資訊，請參閱[中的匯流排代理訊息服務的相互關聯](http://www.cloudcasts.net/devguide/Default.aspx?id=13029)。
- 公開的 API 或從背景工作的使用者介面或來電者可以存取取得狀態資訊的端點。 可以在回應中包含背景工作必須返回來電者之間的資料。
- 有背景工作回撥 UI 或本機透過 API，表示在預先定義的點，或在完成的狀態。 這可能是透過本機引發的事件，或透過發佈及訂閱機制。 背景工作必須返回來電者之間的資料可以包含在要求或事件的內容。

## <a name="hosting-environment"></a>主控環境

您可以使用各種不同的 Azure 平台服務主控背景的工作︰

- [**Azure Web 應用程式與 WebJobs**](#azure-web-apps-and-webjobs)。 您可以使用 WebJobs 執行不同類型的指令碼或 web 應用程式的內容中的可執行程式範圍為基礎的自訂工作。
- [**Azure 雲端服務 web 及工作者角色**](#azure-cloud-services-web-and-worker-roles)。 您可以撰寫角色為背景工作執行的程式碼。
- [**Azure 虛擬機器**](#azure-virtual-machines)。 如果您有 Windows 服務，或想要使用 Windows 工作排程器，這是常見裝載您專屬的虛擬機器中的背景工作。
- [**Azure 批次**](./batch/batch-technical-overview.md)。 排程受管理的虛擬機器集合上執行計算密集作業的平台服務並可以自動小數位數計算資源，以符合您的工作的需求。

下列各節描述的更多詳細資料，這些選項，並包含考量，協助您選擇適當的選項。

## <a name="azure-web-apps-and-webjobs"></a>Azure Web 應用程式與 WebJobs

您可以使用 Azure WebJobs 執行自訂為 Azure Web 應用程式中的 [背景工作的工作。 以連續的程序，您的 web 應用程式的內容中執行 WebJobs。 從 Azure 排程器或外部因素，例如，變更儲存二進位大型物件和訊息佇列觸發事件回應 WebJobs 也執行。 工作可以啟動和停止視和正常關機。 如果持續執行 WebJob 失敗時，會自動重新啟動。 重試] 和 [錯誤] 動作可設定。

當您設定 WebJob:

- 如果您想要回應事件導向觸發程序的作業，您應為**連續執行**加以設定。 命名網站/wwwroot/app_data/工作/連續的資料夾中儲存的指令碼或程式。
- 如果您想要回應的排程導向觸發程序的作業，您應該將它設定為**排程執行**。 命名網站/wwwroot/app_data/工作/觸發的資料夾中儲存的指令碼或程式。
- 如果您設定工作時，您可以選擇**執行隨選**] 選項，它會在啟動時執行相同的程式碼，以**執行的排程**選項。

Azure WebJobs 執行中的 web 應用程式沙箱。 這表示他們可以用來存取環境變數，並使用 web 應用程式共用資訊，例如連接字串。 工作有權存取的電腦執行作業的唯一識別碼。 名為**AzureWebJobsStorage**的連接字串提供應用程式資料的存取權 Azure 儲存佇列二進位大型物件，以及資料表和存取服務匯流排訊息及通訊。 名為**AzureWebJobsDashboard**的連接字串提供存取工作動作記錄檔。

Azure WebJobs 有下列特性︰

- **安全性**︰ WebJobs 受到的 web 應用程式部署認證。
- **支援的檔案類型**︰ 您可以使用命令指令碼 (.cmd)、 批次檔案 (.bat)、 PowerShell 指令碼 (.ps1) 來定義 WebJobs、 被殼層指令碼 (.sh)、 PHP 指令碼 (php)、 Python 指令碼 (.py)、 JavaScript 程式碼 (.js)，並可執行的程式 （.exe、.jar，及其他資訊）。
- **部署**︰ 部署指令碼和可執行檔，您可以使用 Azure 入口網站中，使用[Azure WebJobs SDK](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)，或將它們複製到下列位置直接 Visual Studio 或[Visual Studio 2013 更新 4](http://www.visualstudio.com/news/vs2013-update4-rc-vs) （您可以建立並部署使用此選項），使用 [ [WebJobsVs](https://visualstudiogallery.msdn.microsoft.com/f4824551-2660-4afa-aba1-1fcc1673c3d0)增益集︰
  - 針對觸發執行︰ 網站/wwwroot/app_data/工作/觸發 / {作業名稱}
  - 連續執行︰ 網站/wwwroot/app_data/工作/連續 / {作業名稱}
- **記錄**︰ Console.Out 都會被視為 （標記） 的資訊。 Console.Error 被視為錯誤。 您可以使用 [Azure 入口網站，以存取監控和診斷資訊。 您可以直接從網站下載記錄檔。 將會儲存在下列位置︰
  - 針對觸發執行︰ Vfs/資料/工作/觸發/工作名稱
  - 連續執行︰ Vfs/資料/工作/連續/工作名稱
- **設定**︰ 您可以使用入口網站、 REST API，以及 PowerShell 設定 WebJobs。 您可以使用 [設定檔名為相同的根目錄，為工作指令碼 settings.job 提供工作的設定資訊。 例如︰
  - {「 stopping_wait_time 」: 60}
  - {「 is_singleton 」: true}

### <a name="considerations"></a>考量

- 根據預設，WebJobs 擴充 web 應用程式。 不過，您可以設定來執行單一的執行個體上**is_singleton**設定屬性設定為**true**的工作。 單一執行個體 WebJobs 很有用您不希望縮放或同時多以執行的工作的執行個體，例如重新索引、 資料分析和類似的工作。
- 最小化工作 web 應用程式的效能的影響，請考慮建立新的應用程式服務方案主機可能長時間執行的 WebJobs 或資源的空白 Azure Web 應用程式執行個體大量。

### <a name="more-information"></a>詳細資訊

- [Azure WebJobs 建議資源](./app-service-web/websites-webjobs-resources.md)的 WebJobs 列出多實用的資源、 下載與範例。

## <a name="azure-cloud-services-web-and-worker-roles"></a>Azure 雲端服務 web 及工作者角色

您可以執行背景的工作網頁角色或在不同的背景工作的角色。 當您決定是否要使用工作者角色，請考慮延展性 elasticity 需求，任務為單位的週期時，放開頻率、 安全性、 容錯、 競爭、 複雜度和邏輯架構。 如需詳細資訊，請參閱[計算資源合併彙算模式](http://msdn.microsoft.com/library/dn589778.aspx)。

有數種方式可實作背景在雲端服務角色中的工作︰

- 建立實作**RoleEntryPoint**類別角色及使用方法執行背景的工作。 WaIISHost.exe 的內容中，執行工作。 他們可以使用 [ **GetSetting**方法**CloudConfigurationManager**類別的載入設定的設定。 如需詳細資訊，請參閱[生命週期 （雲端服務）](#lifecycle-cloud-services)。
- 使用 [啟動工作應用程式啟動時執行背景的工作。 若要強制繼續在背景中執行的工作，請將的**taskType**屬性設為**背景**（如果您不要這麼做，應用程式啟動程序會停止並完成工作，請等候）。 如需詳細資訊，請參閱[執行啟動 Azure 中的工作](./cloud-services/cloud-services-startup-tasks.md)。
- 使用 WebJobs SDK 實作背景的工作，例如 WebJobs 會啟動啟動工作。 如需詳細資訊，請參閱[Azure WebJobs SDK 快速入門](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)。
- 使用 「 啟動工作安裝執行一個或多個背景的工作的 Windows 服務。 您必須設定**taskType**屬性**背景**，以便在背景中執行服務。 如需詳細資訊，請參閱[執行啟動 Azure 中的工作](./cloud-services/cloud-services-startup-tasks.md)。

### <a name="running-background-tasks-in-the-web-role"></a>在網頁角色執行背景的工作

在網頁角色執行背景的工作的主要優點是裝載成本，因為沒有部署其他角色的需求儲存檔案。

### <a name="running-background-tasks-in-a-worker-role"></a>在 [背景工作角色中執行背景的工作

在 [背景工作角色中執行背景的工作有幾項優點︰

- 其可讓您管理縮放比例分開每一種角色。 例如，您可能需要更多角色的執行個體 web 支援目前的載入，但較少的執行個體的工作者角色執行背景的工作。 縮放比例分開的 UI 角色的背景工作計算執行個體，您可以管理成本，減少維持可接受的效能。
- 它會卸載處理負荷背景從 web 角色的工作。 提供 UI 網頁角色可以保持回應，並可能是較少的執行個體，才能支援要求使用者指定的數量。
- 其可讓您實作分離問題。 每一種角色類型可以實作特定的一組明確定義和相關工作。 如此可讓設計和維護程式碼更容易，因為沒有小於相依關係分解的程式碼和每個角色之間的功能。
- 它可以協助隔離機密的程序與資料。 例如，實作 UI 的 web 角色不需要有資料的管理，所控制的工作者角色的存取權。 這可以用來加強安全性，尤其是當您使用的圖樣，例如[閘道管理員模式](http://msdn.microsoft.com/library/dn589793.aspx)時。  

### <a name="considerations"></a>考量

選擇方式及位置時，請考慮下列幾點部署背景的工作，使用 Cloud Services web 及工作者角色時︰

- 管理現有的 web 角色中的背景工作，可以儲存執行這些任務只要不同的背景工作角色的成本。 不過，很可能會影響效能與應用程式的可用性如果競爭處理及其他資源。 使用不同的背景工作角色網頁角色防止長或資源背景的工作的影響。
- 如果您使用**RoleEntryPoint**類別主控背景的工作，您可以輕鬆地移動這至另一個角色。 例如，如果您在網頁角色中建立類別，稍後再決定您需要執行工作者角色中的工作，您可以移動**RoleEntryPoint**類別實作工作者角色。
- 啟動工作是設計用來執行程式或指令碼。 部署為可執行程式的背景工作可能會更加困難，尤其是如果也需要部署相依組件。 可能會更容易部署及使用指令碼定義的背景工作，當您使用 「 啟動工作。
- 使背景工作失敗的例外狀況有不同的影響，根據所裝載的方式︰
  - 如果您使用**RoleEntryPoint**類別方法，失敗的工作會導致重新開始，會自動重新啟動工作的角色。 這可能會影響應用程式的可用性。 若要避免此問題，請確定您包含強大**RoleEntryPoint**課程和背景的所有工作中處理的例外狀況。 若要重新啟動工作失敗，這是適用，請使用程式碼，而且例外狀況，只有當您無法順利復原從失敗，在程式碼中，重新啟動角色。
  - 如果您使用 「 啟動工作，您負責管理工作的執行，並檢查如果失敗。
- 管理及監視啟動工作很難比使用**RoleEntryPoint**類別方法。 不過，Azure WebJobs SDK 包含儀表板，使其更容易管理 WebJobs 透過啟動工作開始。

### <a name="more-information"></a>詳細資訊

- [計算資源合併彙算模式](http://msdn.microsoft.com/library/dn589778.aspx)
- [Azure WebJobs SDK 快速入門](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)

## <a name="azure-virtual-machines"></a>Azure 虛擬機器

背景的工作可能實作以防止部署至 Azure Web 應用程式或雲端服務的方式，或可能不方便這些選項。 一般範例包括 Windows 服務和協力廠商的公用以及可執行的程式。 另一個範例可能不同的主機服務應用程式的執行環境的程式。 例如，可能想要執行的 Windows] 或 [.NET 應用程式從 Unix 或 Linux 程式。 您可以選擇 [從 Azure 虛擬機器，作業系統的範圍，並執行您的服務或可執行檔的虛擬機器上。

若要協助您選擇使用虛擬機器的時機，請參閱[Azure 應用程式服務、 雲端服務與虛擬機器比較](./app-service-web/choose-web-site-cloud-service-vm.md)。 虛擬機器選項的相關資訊，請參閱[Azure 虛擬機器和雲端服務的大小](http://msdn.microsoft.com/library/azure/dn197896.aspx)。 如需有關的作業系統與預先建立的虛擬機器可使用的圖像的詳細資訊，請參閱[Azure 虛擬機器 Marketplace](https://azure.microsoft.com/gallery/virtual-machines/)。

若要啟動另一個虛擬機器中的背景工作，您有一系列的選項︰

- 您可以執行工作視直接從您的應用程式要求傳送至任務公開端點。 這會傳遞任何任務所需要的資料。 此端點叫用工作。
- 您可以設定的排程執行使用排程器或有您所選的作業系統的計時器工作。 例如，在 Windows 中，您可以使用 Windows 工作排程器執行指令碼和工作。 或者，如果您有安裝虛擬機器上的 SQL Server，您可以使用 SQL Server 代理程式來執行指令碼和工作。
- 若要將郵件新增至佇列工作接聽，或傳送任務公開 API 邀請啟動工作，您可以使用 Azure 排程器。

請參閱前一節[引動程序](#triggers)如需有關如何您都可以啟動背景的工作。  

### <a name="considerations"></a>考量

當您決定是否要部署背景 Azure 虛擬機器中的工作，請考慮下列幾點︰

- 裝載背景個別 Azure 虛擬機器中的工作會提供彈性，並讓精確地控制初始、 執行、 排程和資源分派。 不過，可能會增加執行階段成本虛擬機器必須部署只是要執行背景的工作。
- 有監視 Azure 入口網站和失敗的工作，沒有自動重新啟動功能中的工作，雖然您可以監視基本的虛擬機器狀態，並使用[Azure 服務管理 Cmdlet](http://msdn.microsoft.com/library/azure/dn495240.aspx)來管理功能。 然而，有來控制程序和運算節點中的往來沒有設備。 一般而言，使用虛擬機器需要額外的工作，來實作收集儀器在工作中，從和作業系統的虛擬機器中的資料機制。 一個可能適合的解決方案是使用[系統管理中心 Management Pack for Azure](http://technet.microsoft.com/library/gg276383.aspx)。
- 您可以考慮建立監控探查公開透過 HTTP 端點。 這些探查的程式碼，都無法執行狀況檢查、 收集操作資訊和統計資料-或自動分頁錯誤資訊，並返回管理應用程式。 如需詳細資訊，請參閱[狀況端點監控圖樣](http://msdn.microsoft.com/library/dn589789.aspx)。

### <a name="more-information"></a>詳細資訊

- 在 Azure[虛擬機器](https://azure.microsoft.com/services/virtual-machines/)
- [Azure 虛擬機器常見問題集](virtual-machines/virtual-machines-linux-classic-faq.md)

## <a name="design-considerations"></a>設計考量

有數種基本的因素考量的事項設計背景的工作。 下列各節討論分割、 衝突以及協調。

## <a name="partitioning"></a>分割

如果您決定要包含背景的工作 （例如 web 應用程式、 web 角色、 現有工作者角色或虛擬機器） 現有的運算執行個體中，您必須考慮這將如何影響計算執行個體和背景工作本身的品質屬性。 這些因素可協助您決定是否要可與現有的運算執行個體的工作或將它們分成個別計算執行個體︰

- **可用性**︰ 背景的工作可能不需要的其他部分的應用程式，以顯示狀態相同層級特別 UI 和直接參與使用者互動的其他部分。 背景的工作可能會更具彈性的延遲，嘗試的連線失敗，因為會佇列作業的其他因素的影響可用性。 不過，必須要有足夠容量，以防止要求並封鎖佇列，會影響整個應用程式的備份。
- **延展性**︰ 背景的工作是可能會有不同的延展性需求比 UI 和互動式部分應用程式。 縮放比例 UI 可能需要進行時未完成的背景的工作可能會在較少忙碌時間完成較少的需求，計算執行個體的數字。
- **恢復功能**︰ 計算該執行個體只裝載背景的工作失敗可能不受的傷足以會影響整個應用程式可以佇列或延後工作時，即可使用，直到這些工作要求。 如果運算執行個體及/或任務可以重新啟動適當的間隔內，可能不會影響使用者的應用程式。
- **安全性**︰ 背景的工作可能會有不同的安全性需求或比 UI 或應用程式的其他部分的限制。 藉由使用不同的計算執行個體，您可以指定工作的不同的安全性環境。 您也可以使用模式，例如閘道管理員才能最大化的安全性和分裂隔離 ui 背景計算執行個體。
- **效能**︰ 的特別符合項目工作背景的工作的效能需求，您可以選擇計算執行個體的類型。 這可能表示如果工作並不需要的 UI，或更大的執行個體的相同處理功能，如果需要額外的容量和資源，請使用較便宜的計算選項。
- **管理能力**︰ 背景的工作可能需要從主要的應用程式碼或 UI 不同開發及部署節奏持續。 部署至不同的計算執行個體，可以簡化更新及版本設定。
- **成本**︰ 新增計算執行背景工作增加裝載成本的執行個體。 您應該謹慎取捨其他容量和這些額外的成本。

如需詳細資訊，請參閱[前置字元選舉模式](http://msdn.microsoft.com/library/dn568104.aspx)和[競爭消費者圖樣](http://msdn.microsoft.com/library/dn568101.aspx)。

## <a name="conflicts"></a>衝突

如果您有多個執行個體的 [背景工作時，可能是它們會競爭資源和服務，例如資料庫及儲存空間的存取權。 這種同時存取可能會導致資源競爭，可能會導致衝突的服務可用性和儲存區中的資料的完整性。 您可以使用悲觀工期鎖定方法來解決資源競爭。 如此可避免佔用同時存取服務或損毀資料的工作的執行個體。

另一種方法來解決衝突可定義背景的工作，為單一，如此就會執行只有一個執行個體。 不過，如此可提供多個執行個體設定可靠性和效能優點。 特別是如果 UI 可以提供將多個背景工作忙碌足夠的工作。

請務必確保背景工作，可以自動重新啟動，且其應付的需求有足夠的容量。 您可以將它達到配置足夠的資源，計算執行個體，或使用這些技術的組合來實作佇列機制，可以儲存稍後執行時要求將會減少的要求。

## <a name="coordination"></a>協調

背景的工作可能會很複雜，且可能需要執行產生結果或 fulfil 所有需求的多個個別工作。 通常會在這些情況下，將工作分成較小小心謹慎步驟或多個使用者皆可以執行的子任務。 多個步驟的工作可能會更有效率且更有彈性，因為個別的步驟可能是在多個工作中的 [可重複使用。 也很容易新增、 移除或修改步驟的順序。

協調多個任務與步驟並不容易，但有三個常見的模式，您可以使用指南解決方案的實作︰

- **分解工作分成多個可重複使用的步驟**。 應用程式，可能需要執行各種不同的複雜的工作處理的資訊。 執行整合模組為此處理可能乾淨的簡單，但強制性的方法，若要執行這個應用程式。 不過，這種方法是將降低重構程式碼、 最佳化，或如果相同處理的部分所需的應用程式中的其他地方重複使用的商機。 如需詳細資訊，請參閱[管道和篩選模式](http://msdn.microsoft.com/library/dn568100.aspx)。
- **管理工作的步驟執行**。 應用程式可能會執行組成的步驟 （其中一些可能叫用遠端服務存取遠端資源） 的數字的工作。 個別的步驟可能獨立於彼此，但它們協調實作工作的應用程式邏輯。 如需詳細資訊，請參閱[排程器代理程式的主管圖樣](http://msdn.microsoft.com/library/dn589780.aspx)。
- **管理工作的步驟無法復原**。 應用程式，可能需要復原由一系列的步驟 （最後一致的作業定義） 來執行的工作，如果一個或多個步驟會失敗。 如需詳細資訊，請參閱[補償交易圖樣](http://msdn.microsoft.com/library/dn589804.aspx)。

## <a name="lifecycle-cloud-services"></a>生命週期 （雲端服務）

 如果您決定實作雲端服務使用的應用程式網頁和工作者角色使用**RoleEntryPoint**類別的 [背景工作，請務必正確地使用它時，瞭解此課程的生命週期。

Web 及工作者角色經過一組不同階段的開始、 執行，並停止。 **RoleEntryPoint**類別公開一系列的事件，表示這些階段發生時。 您使用這些初始化，執行，並停止您自訂的背景的工作。 完成的循環圖是︰

- Azure 載入角色及搜尋衍生自**RoleEntryPoint**的類別。
- 如果找到此課程，它會呼叫**RoleEntryPoint.OnStart()**。 您會覆寫此方法以初始化背景的工作。
- **OnStart**方法完成之後，Azure 通話**Application_Start()**此應用程式的通用檔案中會呈現 （例如，在執行 ASP.NET web 角色 Global.asax）。
- Azure 上執行與**OnStart()**平行的新前景執行緒通話**RoleEntryPoint.Run()** 。 您會覆寫這個方法來啟動您背景的工作。
- 執行方法結束時，Azure 第一次通話**Application_End()**應用程式的通用檔案如果這是，，然後呼叫**RoleEntryPoint.OnStop()**。 您會覆寫**OnStop**方法將停止背景的工作，清除資源、 配置的物件，並關閉工作可能已經使用的連線。
- 已停止 Azure 工作者角色主機處理程序。 此時，角色回收，並會重新啟動。

如需更多詳細資料與範例使用**RoleEntryPoint**類別的方法，請參閱[計算資源合併彙算模式](http://msdn.microsoft.com/library/dn589778.aspx)。

## <a name="considerations"></a>考量

當您規劃如何在網頁或背景工作角色執行背景的工作，請考慮下列幾點︰

- 預設**執行**方法實作**RoleEntryPoint**類別中的包含在通話**Thread.Sleep(Timeout.Infinite)**無限期保留角色作用的。 如果您覆寫的**執行**方式 （這是通常需要執行背景的工作），您必須允許您的程式碼，若要結束從方法，除非您想要的角色執行個體的資源回收。
- **執行**方法的一般實作包含每個背景的工作和定期檢查所有背景的工作狀態的循環播放建構啟動的程式碼。 它可以重新啟動任何失敗或監視的取消權杖指出已完成的工作。
- 如果背景工作擲回處理的例外狀況，該任務應該回收同時，繼續執行角色允許其他背景的工作。 不過，如果例外狀況損毀的工作，例如共用的儲存空間外的物件應由**RoleEntryPoint**課程處理的例外狀況、 應該取消所有工作，，若要結束允許的**執行**方式。 Azure 會重新啟動角色。
- 使用 [ **OnStop**方法來暫停或刪除背景的工作或清除資源。 這可能需要停止長或多重步驟的工作。 請務必考慮如何完成此若要避免資料不一致。 如果角色執行個體，停止使用者啟動的關機以外的任何原因必須強制結束前的 5 分鐘內完成**OnStop**方法中執行的程式碼。 請確定您的程式碼可以完成的時間，或可容許不在執行中完成。  
- Azure 負載平衡器開始**RoleEntryPoint.OnStart**方法傳回的值**，則為 true**時，導向至角色的執行個體的流量。 因此，請考慮將所有初始化程式碼都放入**OnStart**方法，讓成功未初始化的角色執行個體不會收到任何流量。
- 您可以使用啟動工作，除了**RoleEntryPoint**類別的方法。 您應該使用啟動工作初始化您需要變更 Azure 負載平衡器中，因為角色收到任何要求之前，會執行這些工作的任何設定。 如需詳細資訊，請參閱[執行啟動 Azure 中的工作](./cloud-services/cloud-services-startup-tasks.md)。
- 如果發生錯誤時啟動任務，也可能會強制持續重新啟動的角色。 這可以讓您無法執行虛擬 IP (VIP) 地址交換回到先前分段版本，因為交換需要獨佔式存取權的角色。 重新啟動角色時無法取得此。 若要解決這個問題︰
    -  將下列程式碼新增至您的角色**OnStart**及**執行**方式開頭︰

    ```C#
    var freeze = CloudConfigurationManager.GetSetting("Freeze");
    if (freeze != null)
    {
        if (Boolean.Parse(freeze))
        {
            Thread.Sleep(System.Threading.Timeout.Infinite);
        }
    }
    ```

   - 在 ServiceDefinition.csdef 和 ServiceConfiguration 為一個 Boolean 值，新增 [**凍結**] 設定的定義。*角色.cscfg 檔案並將其**false**.如果角色進入重複重新啟動模式時，您可以將設定變更為* *true** 若要凍結角色執行，並允許以舊版交換。

## <a name="resiliency-considerations"></a>恢復考量

背景的工作都必須同時才能提供可靠的服務應用程式。 當您規劃，設計背景的工作時，請考慮下列幾點︰

- 您必須能夠正常處理沒有損毀資料，或在應用程式中介紹不一致的角色或服務重新啟動背景的工作。 長或多重步驟的工作，請考慮使用_檢查指出_儲存如果這是適當的工作狀態為在持續存放區，或佇列中的郵件。 比方說，您可以保存在佇列中郵件的陳述式資訊，並從屬參照更新此陳述式資訊與任務進度，使工作可以處理從最後一個已知建議檢查點，而不是從開始重新啟動。 在使用 Azure 服務匯流排佇列時，您可以使用訊息工作階段啟用相同狀況。 工作階段允許您儲存並使用[SetState](http://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.setstate.aspx)和[GetState](http://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.getstate.aspx)方法來擷取的應用程式處理狀態。 如需設計可靠多個步驟的程序與工作流程的詳細資訊，請參閱[排程器代理程式的主管圖樣](http://msdn.microsoft.com/library/dn589780.aspx)。
- 當您使用網頁或背景工作角色裝載多個背景的工作時，設計您覆寫的監視失敗或停止的工作，並重新開啟的**執行**方式。 其中不可行，並使用工作者角色強制結束從**執行**的方法，重新啟動的工作者角色。
- 當您使用的佇列進行通訊的背景的工作，佇列可以做為儲存的任務，在應用程式時傳送要求緩衝低於高於一般載入。 這個選項可讓掌握與 UI 忙碌期間較少的工作。 這也表示的回收角色不會封鎖使用者介面。 如需詳細資訊，請參閱[佇列型負載撫平模式](http://msdn.microsoft.com/library/dn589783.aspx)。 如果部分工作的考量優先於其他人，請考慮實作要確保較不重要的之前執行這些工作的[優先順序佇列圖樣](http://msdn.microsoft.com/library/dn589794.aspx)。
- 背景的工作發起的租用戶的程序的郵件或郵件必須設計處理不一致，例如郵件送達順序、 郵件重複會造成錯誤 （通常稱為_有害的郵件_） 及郵件傳送一次。 考慮下列事項︰
  - 必須以特定順序，例如變更根據現有的資料值 （例如，將值新增至現有的值） 的資料進行處理，可能會送達，原始的順序被傳送的郵件。 或者，可能會以不同的執行個體中以不同的順序，因為每個執行個體上的 [變化載入背景任務的處理。 必須以特定順序處理的郵件應該包含序列數字、 鍵或一些其他指標背景的工作可用於確保他們處理順序正確無誤。 如果您使用的 Azure 服務匯流排，您可以使用訊息工作階段，以確保傳遞的順序。 不過，則通常會更有效率，請盡可能讓郵件順序不重要設計程序。
  - 一般而言，在佇列中，從其他郵件使用者皆會暫時隱藏這些郵件會檢視背景上的工作。 然後會刪除郵件之後成功處理。 如果背景上的工作失敗，處理訊息時，請預覽逾時到期之後的郵件會出現在佇列中。 它會處理另一個執行個體的工作或此執行個體的下一個處理週期。 如果郵件消費者一致導致錯誤，會封鎖工作、 佇列中，最後應用程式本身佇列中已滿時。 因此，是很重要偵測並從佇列中移除有害的郵件。 如果您使用的 Azure 服務匯流排，會導致錯誤的郵件可以相關聯的無法傳送信件佇列自動或手動移動。
  - 在_至少一次_傳送機制保證佇列，但是他們可能會出現一次以上發表相同的郵件。 此外，如果背景上的工作失敗之後處理郵件，但之前從佇列中刪除，郵件會變成適用於處理一次。 背景的工作應該冪，這表示的多次處理相同的郵件不會導致錯誤或不一致的應用程式的資料。 某些作業是自然冪，例如設定為特定的新值的儲存的值。 不過，例如將值新增至現有的儲存值，而不核取 [儲存的值仍然原本傳送訊息的相同的作業會導致不一致性。 若要自動移除重複的郵件，可以設定 azure 服務匯流排佇列。
  - 某些郵件系統，例如 Azure 儲存佇列和 Azure 服務匯流排佇列支援 de-queue 計數屬性，指出佇列中讀取郵件的次數。 這可以用來處理重複有害的郵件。 如需詳細資訊，請參閱[非同步訊息入門](http://msdn.microsoft.com/library/dn589781.aspx)和[等冪性模式](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)。

## <a name="scaling-and-performance-considerations"></a>縮放比例與效能考量

背景的工作必須提供足夠的效能，以確保他們不封鎖應用程式，或在負載系統時，會導致延遲作業的不一致性。 一般而言，藉由縮放主控背景的工作計算執行個體改善效能。 當您規劃，設計背景的工作時，請考慮下列周圍延展性和效能點︰

- Azure 支援自動縮放 （擴展和縮放比例回） 根據目前的需求和載入，或在預先定義的排程，Web 應用程式，雲端服務 web 工作者角色和虛擬機器裝載部署。 若要確保整個應用程式時最小化執行階段成本有足夠的效能功能使用此功能。
- 在背景的工作有來自雲端服務應用程式 （例如，使用者介面或元件，例如資料存取層） 的其他部分不同的效能功能，裝載背景中的工作放在一起的個別工作角色可讓 UI 和背景縮放獨立管理載入工作角色。 如果多個背景的工作彼此顯著效能功能，請考慮將它們分成個別的工作者角色和獨立縮放每一種角色類型。 不過，請注意，這可能會增加執行階段成本相較於將所有工作都合併到較少的角色。
- 只要按比例縮放的角色可能無法避免在負載效能的影響。 您可能也需要調整儲存佇列及其他資源可防止一點的整體處理從障礙鏈結。 此外，請考慮其他限制，例如 [最大值的儲存空間及其他服務應用程式和背景的工作依賴處理量。
- 背景的工作必須針對縮放比例。 例如，他們必須能夠動態偵測使用接聽或將訊息傳送至適當的佇列中的 [儲存空間的佇列數目。
- 根據預設，其相關聯的 Azure Web 應用程式執行個體 WebJobs 小數位數。 不過，如果您想以單一執行個體執行 WebJob 時，您可以建立包含 JSON 資料的 Settings.job 檔案**{「 is_singleton 」: true}**。 這會強制 Azure 只能執行一個執行個體 WebJob，即使有多個執行個體的相關聯的 web 應用程式。 這可能是很有用的技巧排程單一執行個體就必須執行的作業。

## <a name="related-patterns"></a>相關的模式

- [非同步訊息入門](http://msdn.microsoft.com/library/dn589781.aspx)
- [自動縮放指南](http://msdn.microsoft.com/library/dn589774.aspx)
- [補償交易圖樣](http://msdn.microsoft.com/library/dn589804.aspx)
- [競爭消費者圖樣](http://msdn.microsoft.com/library/dn568101.aspx)
- [計算分割指南](http://msdn.microsoft.com/library/dn589773.aspx)
- [計算資源合併彙算模式](http://msdn.microsoft.com/library/dn589778.aspx)
- [閘道管理員圖樣](http://msdn.microsoft.com/library/dn589793.aspx)
- [前置字元選擇模式](http://msdn.microsoft.com/library/dn568104.aspx)
- [管線與篩選模式](http://msdn.microsoft.com/library/dn568100.aspx)
- [優先順序佇列圖樣](http://msdn.microsoft.com/library/dn589794.aspx)
- [佇列中負載資源撫平的圖樣](http://msdn.microsoft.com/library/dn589783.aspx)
- [排程器代理程式的主管圖樣](http://msdn.microsoft.com/library/dn589780.aspx)

## <a name="more-information"></a>詳細資訊

- [縮放比例與工作角色 Azure 應用程式](http://msdn.microsoft.com/library/hh534484.aspx#sec8)
- [執行背景的工作](http://msdn.microsoft.com/library/ff803365.aspx)
- [Azure 角色啟動生命週期](http://blog.syntaxc4.net/post/2011/04/13/windows-azure-role-startup-life-cycle.aspx)（部落格文章）
- [Azure Cloud Services 角色生命週期](http://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Windows-Azure-Cloud-Services-Role-Lifecycle)（影片）
- [Azure WebJobs SDK 快速入門](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)
- [Azure 佇列及服務匯流排佇列-相對於和比較](./service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)
- [若要啟用診斷雲端服務中的方式](./cloud-services/cloud-services-dotnet-diagnostics.md)
