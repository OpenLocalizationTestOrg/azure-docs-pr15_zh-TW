<properties 
   pageTitle="使用者定義的路徑和 IP 轉接是什麼？"
   description="瞭解如何使用使用者定義的路由 (UDR) 和 IP 轉接轉送流量網路中 Azure 虛擬設備。"
   services="virtual-network"
   documentationCenter="na"
   authors="jimdial"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="get-started-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="03/15/2016"
   ms.author="jdial" />

# <a name="what-are-user-defined-routes-and-ip-forwarding"></a>使用者定義的路徑和 IP 轉接是什麼？
當您新增至 Azure 虛擬網路 (VNet) 的虛擬機器 (Vm) 時，您會發現 Vm 就可以彼此透過網路，自動。 您不需要指定閘道，即使 Vm 位於不同的子網路。 同樣適用於從 Vm 到公用網際網路通訊，即使您的內部部署網路時從 Azure 的混合式連線到您自己的資料中心是簡報。

因為 Azure 定義 IP 流量流向如何使用一系列的系統路由，有可能是這個流量的通訊。 系統路由掌控通訊在以下情況︰

- 從子網路相同。
- 從 VNet 內其他子網路。
- 從網際網路 Vm。
- 從另一個 VNet 透過 VPN 閘道器至 VNet。
- 從您的內部部署網路透過 VPN 閘道 VNet。

下圖顯示 VNet、 兩個子網路，且幾個 Vm，以及允許 IP 流量系統路由進行簡單的設定。

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure1.png)

雖然使用系統路由，協助流量自動為您的部署，為您要控制封包路由透過虛擬應用裝置的情況。 您可以，因此您可以建立使用者定義的路徑，指定躍封包傳送到特定的子網路，不過，前往您虛擬應用裝置，並啟用為虛擬應用裝置執行 VM IP 轉寄功能。

下圖顯示使用者定義路由的範例，若要強制封包 IP 轉接傳送給一個子網路的審核虛擬應用裝置的第三個子網路上的另一個。

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure2.png)

>[AZURE.IMPORTANT] 使用者定義路由只套用到離開子網路流量。 您無法建立指定如何流量進入子網路從網際網路]，例如路由。 此外，您是要轉寄至的流量應用裝置無法在相同的子網路流量產生處。 永遠建立不同的子網路，為您的裝置。 

## <a name="route-resource"></a>將資源
封包傳閱實體網路上的每個節點定義傳送資料表為基礎的 TCP/IP 網路上。 將表格是用來決定要轉寄封包根據目的地 IP 位址的個別路由的集合。 路由包含下列各項︰

|屬性|描述|限制式|考量|
|---|---|---|---|
| 地址前置詞 | 路由套用到，例如 10.1.0.0/16 目的地 CIDR。|必須有效的 CIDR 範圍代表公用網際網路、 Azure 虛擬網路或內部部署資料中心的地址。|請確定**位址首碼**不包含的**下一個躍點的位址**，否則您封包會從來源移至下一個躍點不進入目的地循環輸入地址。 |
| 下一步的躍點類型 | Azure 躍點的類型封包應該傳送到。 | 必須為下列值︰ <br/> **虛擬網路**。 代表本機的虛擬網路。 舉個例說，如果您有兩個子網路、 10.1.0.0/16 和 10.2.0.0/16 相同的虛擬網路中，傳送資料表中每一個子網路路線會有*虛擬網路*的下一個躍點的值。 <br/> **虛擬網路閘道器**。 代表 Azure S2S VPN 閘道器。 <br/> **網際網路**。 代表 Azure 基礎結構提供的預設網際網路閘道器。 <br/> **虛擬應用裝置**。 代表您新增至 Azure 虛擬網路的虛擬應用裝置。 <br/> **無**。 代表黑色出口。 黑色出口轉送封包不會在轉寄。| 請考慮使用**無**類型，若要停止封包傳送至指定的目的地。 | 
| 下一步的躍點地址 | 下一步的躍點位址包含封包應該轉寄的目標的 IP 位址。 路由是下一個的躍點類型*虛擬應用裝置*中只允許下一步的躍點值。| 必須是連線到虛擬網路的使用者定義的路由套用的位置中的 IP 位址。 | 如果 IP 位址代表 VM，請確定您啟用 Azure 中的 [ [IP 轉接](#IP-forwarding)VM。 |

在 PowerShell 的 Azure 部分的 「 NextHopType 」 值會有不同的名稱︰
- 虛擬網路是 VnetLocal
- 虛擬網路閘道器在 VirtualNetworkGateway
- 虛擬應用裝置是 VirtualAppliance
- 網際網路是網際網路
- 無到期日

### <a name="system-routes"></a>系統路由
建立虛擬網路中的每一個子網路是自動傳送資料表，其中包含以下系統傳閱規則與相關聯的︰

- **本機 Vnet 規則**︰ 此規則會自動建立虛擬網路中的每一個子網路。 它會指定在 VNet Vm 間有的直接連結，並有無中間的下一個躍點。
- **內部部署規則**︰ 此規則套用至所有流量的內部部署位址範圍並使用 VPN 閘道器的下一個躍點目的。
- **網際網路規則**︰ 此規則的控點所有流量傳送至公用網際網路 (地址前置詞 0.0.0.0/0)，及使用基礎結構網際網路閘道器標示為躍所有流量傳送至網際網路。

### <a name="user-defined-routes"></a>使用者定義的路徑
大部分的環境，您會只需要已定義的 Azure 系統路由。 不過，您可能需要建立路由資料表，並在特定情況下，新增一個或多個路由，例如︰

- [強迫跳至您的內部部署網路透過網際網路通道。
- Azure 環境中的虛擬設備的使用方式。

在上述案例中，您必須建立路由資料表，並為其新增使用者定義的路徑。 您可以有多個路由資料表，且相同路由資料表可以有關聯到一或多個子網路。 與每一個子網路僅可為單一路由表格相關聯。 所有 Vm 和子網路使用 [傳送] 資料表中的雲端服務與相關都聯的子網路。

子網路依賴系統路由，直到傳送表格至子網路相關聯。 關聯存在，路由是根據上最長加上字首須相符 (LPM) 之間系統路由和使用者定義的路徑。 如果有多個相同 LPM 符合的項目路由傳送已選取根據原始以下列順序︰

1. 使用者定義的傳送
1. BGP 路由 （時使用 ExpressRoute）
1. 系統傳送

若要瞭解如何建立使用者定義的路徑，請參閱[如何建立路徑並啟用轉接 Azure 中的 IP](virtual-network-create-udr-arm-template.md)。

>[AZURE.IMPORTANT] 使用者定義路由只套用到 Azure Vm 和雲端服務。 舉個例說，如果您想要新增您的內部部署網路和 Azure 之間的防火牆虛擬應用裝置，您就必須建立使用者定義的路由 Azure 路由表格轉寄前往虛擬應用裝置的內部部署地址空間的所有流量的。 您也可以新增的使用者定義路由 (UDR) 若要將來自內部部署轉送所有流量到 Azure 透過虛擬應用裝置 GatewaySubnet。 這是最近的元件。

### <a name="bgp-routes"></a>BGP 路由
如果您擁有內部部署網路之間 Azure ExpressRoute 連線，您可以啟用 BGP，才會傳播 Azure 從您的內部部署網路路由。 在相同的方式系統路由和每個 Azure 子網路中的使用者定義路由會使用這些 BGP 路由。 如需詳細資訊，請參閱[ExpressRoute 簡介](../expressroute/expressroute-introduction.md)。

>[AZURE.IMPORTANT] 您可以設定使用強制藉由建立子網路 0.0.0.0/0 與躍使用 VPN 閘道器的使用者定義的路由到內部部署網路通道 Azure 環境。 不過，這只能如果您使用的 VPN 閘道，不 ExpressRoute。 ExpressRoute，強制通道是透過 BGP 設定。

## <a name="ip-forwarding"></a>IP 轉送
為上述，建立使用者定義的路由主要原因之一是傳輸轉寄至的虛擬應用裝置。 虛擬應用裝置只是 VM 執行應用程式，用來處理方式，例如防火牆或 NAT 裝置的網路流量。

此虛擬應用裝置 VM 必須要能夠接收並未解決本身的內送流量。 若要允許接收流量傳送至其他目的地 VM，您必須啟用 IP 轉接 vm。 這是 Azure 設定 」、 「 訪客系統中的設定。

## <a name="next-steps"></a>後續步驟

- 瞭解如何[建立路由在資源管理員部署模型](virtual-network-create-udr-arm-template.md)，並產生關聯到子網路。 
- 瞭解如何[建立傳統的部署模型中的路徑](virtual-network-create-udr-classic-ps.md)，並產生關聯到子網路。
