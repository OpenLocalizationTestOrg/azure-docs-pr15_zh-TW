<properties 
   pageTitle="混合式連線 2 層應用程式 |Microsoft Azure"
   description="瞭解如何將虛擬就和 Azure 中建立多層應用程式的環境 UDR 部署"
   services="virtual-network"
   documentationCenter="na"
   authors="jimdial"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/05/2016"
   ms.author="jdial" />

# <a name="virtual-appliance-scenario"></a>虛擬應用裝置案例

在較大的 Azure 客戶常見的案例是需要提供兩層應用程式時從內部部署資料中心，以返回層允許存取網際網路上公開。 這份文件會逐步引導您完成部署符合下列需求的兩層環境中使用使用者定義的路由 (UDR)、 VPN 閘道和網路虛擬應用裝置的情況︰

- Web 應用程式必須從公用網際網路存取。
- 管理應用程式網頁伺服器，必須能夠存取後端應用程式伺服器。
- 從網際網路所有流量導向的 web 應用程式必須經過防火牆虛擬應用裝置。 網際網路流量只適用於此虛擬應用裝置。
- 移至 [應用程式伺服器的所有流量必須都經過防火牆虛擬應用裝置。 存取的後端結束伺服器及存取來自內部部署網路透過 VPN 閘道器都將使用此虛擬應用裝置。
- 系統管理員必須為能管理防火牆虛擬就從他們的內部部署電腦上，使用第三個防火牆專用於管理用途的虛擬應用裝置。

這是標準的 DMZ 案例 DMZ 與受保護的網路。 這種情況建構 Azure 使用 NSGs、 防火牆虛擬裝置或兩者的組合。 下表顯示一些 NSGs 和防火牆虛擬裝置之間優缺點。

||專業人員|缺點|
|---|---|---|
|NSG|不需要成本。 <br/>整合至 Azure RBAC。 <br/>ARM 範本中，可以建立規則。|複雜度較大的環境中可能會視情況而定。 |
|防火牆|完全控制資料平面的詳細資訊。 <br/>透過防火牆主控台的中央管理。|防火牆應用裝置的成本。 <br/>無法與 Azure RBAC 整合。|

下列方案使用防火牆虛擬就實作 DMZ/受保護的網路案例。

## <a name="considerations"></a>考量

您可以部署環境中使用不同的功能，today、，如下所示的 Azure 說明上方。

- **虛擬網路 (VNet)**。 Azure VNet 是以到內部部署網路，類似的方式，並可以區隔到一或多個子網路，提供流量隔離和分離問題。
- **虛擬應用裝置**。 多個合作夥伴提供虛擬就可以使用上述三個防火牆 Azure Marketplace 中。 
- **使用者定義的路徑 (UDR)**。 將資料表可以包含 UDRs Azure 網路用來控制內 VNet 封包的流程。 這些路由資料表可以套用至子網路。 Azure 中的最新功能是將路由表套用至 GatewaySubnet，讓您能夠轉寄所有來自流量到 Azure VNet 混合式連線至虛擬應用裝置的功能。
- **IP 轉寄功能**。 根據預設，Azure 網路引擎轉寄虛擬網路介面卡 (Nic) 的封包才封包目的地 IP 位址符合 NIC IP 位址。 因此，如果 UDR 所定義的封包必須將傳送至指定的虛擬應用裝置，Azure 網路引擎會放封包。 若要確保封包已傳送給 VM （在此例虛擬應用裝置） 的不是封包的實際的目的地，必須先啟用 IP 轉接虛擬應用裝置。
- **網路安全性群組 (NSGs)**。 下面的範例中不會讓使用 NSGs，但您可以使用此方案中套用至子網路及/或 Nic NSGs 進一步篩選與這些子網路和 Nic 登出流量。


![IPv6 連線](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

在此範例中有訂閱包含下列動作︰

- 2 資源群組]，不會顯示在圖表中。 
    - **ONPREMRG**。 包含要模擬內部部署網路所需的所有資源。
    - **AZURERG**。 包含所有資源所需的 Azure 虛擬網路環境。 
- VNet 命名**onpremvnet**用來模仿分段如下所示的內部部署資料中心。
    - **onpremsn1**。 包含虛擬機器 (VM) 執行 Ubuntu 來模仿內部部署伺服器子網路。
    - **onpremsn2**。 包含 VM 執行 Ubuntu 來模仿系統管理員使用內部部署電腦子網路。
- 有一個防火牆虛擬應用裝置上用來維護**azurevnet**通道**onpremvnet**命名為**OPFW** 。
- 名為**azurevnet** VNet 區隔如下所示。
    - **azsn1**。 專用於外部防火牆外部防火牆子網路。 所有的網際網路流量會經過子網路。 子網路只包含連結至外部防火牆 NIC。
    - **azsn2**。 主機服務會從網際網路存取的網頁伺服器以執行 VM 前端子網路。
    - **azsn3**。 後端子網路主機服務 VM 執行會透過前端網頁伺服器的後端應用程式伺服器。
    - **azsn4**。 使用以獨佔模式來管理存取所有的防火牆虛擬就管理子網路。 子網路只包含 NIC 方案中使用每個防火牆虛擬應用裝置。
    - **GatewaySubnet**。 Azure 混合式連線子網路和所需的 ExpressRoute VPN 閘道器提供 Azure VNets 與其他網路之間的連線。 
- 有 3 的防火牆虛擬就**azurevnet**網路中。 
    - **AZF1**。 使用 Azure 中的公用 IP 位址資源公用網際網路上公開的外部防火牆。 您必須以確定您有範本從 [市集]，或直接從您的應用裝置供應商，該條款 3 NIC 虛擬應用裝置。
    - **AZF2**。 用來控制**azsn2**和**azsn3**之間的流量的內部防火牆。 這也是 3 NIC 虛擬應用裝置。
    - **AZF3**。 管理防火牆存取系統管理員的內部部署資料中心，並用於管理所有防火牆裝置管理子網路連線。 您可以在 [市集]，尋找 2 NIC 虛擬應用裝置範本，或要求直接從您的應用裝置廠商。

## <a name="user-defined-routing-udr"></a>使用者定義路由 (UDR)

Azure 中的每一個子網路可以連結至用來定義如何流量發起的租用戶的子網路路由 UDR 資料表。 如果沒有 UDRs Azure 會使用預設路由，讓傳輸至另一個從一個子網路流量。 若要進一步瞭解 UDRs，請造訪[什麼是使用者定義的路徑和 IP 轉寄功能](./virtual-networks-udr-overview.md#ip-forwarding)。

若要確保正確的防火牆應用裝置，根據上述的最後一個需求透過完成通訊必須建立下列路由資料表包含**azurevnet**UDRs。

### <a name="azgwudr"></a>azgwudr

在這個案例中，只流量流向來自內部部署 Azure 將用來管理防火牆連線到**AZF3**，，流量必須通過內部防火牆**AZF2**。 因此，只有一個路由是必要的**GatewaySubnet**如下所示。

|目的地|下一步的躍點|說明|
|---|---|---|
|10.0.4.0/24|10.0.3.11|可讓內部部署流量到達管理防火牆**AZF3**|

### <a name="azsn2udr"></a>azsn2udr

|目的地|下一步的躍點|說明|
|---|---|---|
|10.0.3.0/24|10.0.2.11|允許到裝載**AZF2**透過應用程式伺服器的後端子網路流量|
|0.0.0.0/0|10.0.2.10|可讓所有其他的流量會透過**AZF1**路由|

### <a name="azsn3udr"></a>azsn3udr

|目的地|下一步的躍點|說明|
|---|---|---|
|10.0.2.0/24|10.0.3.10|可讓流量流向從應用程式伺服器 web 伺服器上透過**AZF2** **azsn2**|

您也需要**onpremvnet**來模仿內部部署資料中心中建立子網路路由資料表。

### <a name="onpremsn1udr"></a>onpremsn1udr

|目的地|下一步的躍點|說明|
|---|---|---|
|192.168.2.0/24|192.168.1.4|允許透過**OPFW** **onpremsn2**傳輸|

### <a name="onpremsn2udr"></a>onpremsn2udr

|目的地|下一步的躍點|說明|
|---|---|---|
|10.0.3.0/24|192.168.2.4|允許**OPFW**透過 Azure 中的備份子網路流量|
|192.168.1.0/24|192.168.2.4|允許透過**OPFW** **onpremsn1**傳輸|

## <a name="ip-forwarding"></a>IP 轉送 

UDR 和 IP 轉接為功能，您可以使用允許虛擬就来用來控制中 Azure VNet 流量的組合。  虛擬應用裝置只是 VM 執行應用程式，用來處理方式，例如防火牆或 NAT 裝置的網路流量。

此虛擬應用裝置 VM 必須要能夠接收並未解決本身的內送流量。 若要允許接收流量傳送至其他目的地 VM，您必須啟用 IP 轉接 vm。 這是 Azure 設定 」、 「 訪客系統中的設定。 您的虛擬應用裝置仍然需要執行某些類型的控點向內傳輸，並將它傳送到適當的應用程式。

若要瞭解關於 IP 轉寄功能的詳細資訊，請造訪[什麼是使用者定義的路徑和 IP 轉寄功能](./virtual-networks-udr-overview.md#ip-forwarding)。

例如，假設您有下列設定 Azure vnet 中︰

- 子網路**onpremsn1**包含名稱為**onpremvm1**VM。
- 子網路**onpremsn2**包含名稱為**onpremvm2**VM。
- 名為**OPFW**的虛擬應用裝置連接到**onpremsn1**和**onpremsn2**。
- 連結至**onpremsn1**的使用者定義路由指定在所有流量**onpremsn2**必須都傳送**OPFW**。

此時，如果**onpremvm1**嘗試與**onpremvm2**建立連線，UDR 將會用於和流量便會傳送到**OPFW**為一個躍點。 請記住不變更實際封包目的地，仍顯示**onpremvm2**是目的地。 

不 IP 轉寄啟用**OPFW**，Azure 虛擬網路邏輯會卸除封包，它只允許封包傳送到 VM 如果 VM 的 IP 位址是封包的目的地。

使用 IP 轉接，Azure 虛擬網路邏輯會轉寄封包至 OPFW，而不變更其原始的目的地地址。 **OPFW**必須處理封包，並決定所要進行的作業。

用於上述案例搭配使用，您必須啟用 IP 轉接在 Nic **OPFW**、 **AZF1**、 **AZF2**，及**AZF3**用來路由 (所有 Nic 連結到管理子網路除外)。 

## <a name="firewall-rules"></a>防火牆規則

如上所述，IP 只能轉接可確保封包會傳送到虛擬設備。 決定如何處理這些封包仍然需要您的應用裝置。 在上述案例中，您將需要您的裝置中建立下列規則︰

### <a name="opfw"></a>OPFW

OPFW 代表包含下列規則在內部部署裝置︰

- **路由**︰ 必須透過通道**ONPREMAZURE**傳送所有 10.0.0.0/16 (**azurevnet**) 的流量。
- **原則**︰ 允許**port2**和**ONPREMAZURE**之間的所有雙向流量。
 
### <a name="azf1"></a>AZF1

AZF1 代表包含下列規則的 Azure 虛擬應用裝置︰

- **原則**︰ 允許**連接埠 1**和**port2**之間的所有雙向流量。

### <a name="azf2"></a>AZF2

AZF2 代表包含下列規則的 Azure 虛擬應用裝置︰

- **路由**︰ 所有 10.0.0.0/16 (**onpremvnet**) 的流量必須將都傳送至**連接埠 1**透過 Azure 閘道器 IP 位址 (亦即 10.0.0.1)。
- **原則**︰ 允許**連接埠 1**和**port2**之間的所有雙向流量。

## <a name="network-security-groups-nsgs"></a>網路安全性群組 (NSGs)

在此案例中，NSGs 未使用。 不過，您可以套用 NSGs 來限制內送和外寄流量的每一個子網路。 例如，您可以套用下列 NSG 規則至外部轉址子網路。

**內送**

- 允許網際網路上任何 VM 子網路中的連接埠 80 所有 TCP 流量。
- 從網際網路拒絕所有其他流量。

**撥出**
- 拒絕所有流量至網際網路。

## <a name="high-level-steps"></a>高等級的步驟

若要部署這種情況下，遵循下列步驟，高等級。

1.  登入您的 Azure 訂閱。
2.  如果您想要部署 VNet 來模仿內部部署網路，提供屬於**ONPREMRG**的資源。
3.  佈建屬於**AZURERG**的資源。
4.  佈建到**azurevnet** **onpremvnet**通道。
5.  之後的所有資源佈建都後，請登入**onpremvm2**並偵測 （ping） 10.0.3.101 測試**onpremsn2**與**azsn3**之間的連線。
