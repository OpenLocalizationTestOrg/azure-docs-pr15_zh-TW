#<a name="azure-service-bus"></a>Azure 服務匯流排

是否在雲端，或內部部署，可執行應用程式或服務，通常需要其他應用程式或服務進行互動。 若要提供廣泛有用的方式執行此動作，Azure 提供服務匯流排。 本文將引導您瞭解這項說明這是什麼，您可能會想要使用的技術。

## <a name="service-bus-fundamentals"></a>服務匯流排基本概念
不同的情況下連絡的不同樣式的通訊。 有時候，讓應用程式傳送及接收郵件，透過簡單佇列是最佳解決方案。 在其他情況下，一般的佇列中是不夠;以發佈與訂閱機制佇列是較佳。 在某些情況下，真的需要是應用程式與 #151 之間的連線; 佇列不需要。 服務匯流排提供三個選項，讓您以數種不同方式互動的應用程式。

服務匯流排是多租用戶雲端服務，這表示多位使用者的共用服務。 每個使用者，例如應用程式開發人員]，建立*命名空間*，，然後定義該命名空間中，所以必須通訊機制。 [圖 1](#Fig1)顯示此所呈現的外觀。

<a name="Fig1"></a>![Azure 服務匯流排的圖表][svc-bus]
 
**圖 1︰ 服務匯流排提供多租用戶服務的連線到雲端的應用程式。**

在命名空間，您可以使用一或多個執行個體的四個不同的通訊機制，每個連線的應用程式中使用不同的方式。 有下列選擇︰

- *佇列*，可允許一個雙向通訊。 每個佇列做為媒介 （有時稱為*代理人*） 儲存已傳送的郵件，直到已接收。 單一收件者會收到每一封郵件。
- *主題*，提供一個雙向通訊使用*訂閱*-單一主題可以有多個訂閱。 例如佇列中，主題做為代理人，但每個訂閱可以選擇性地使用篩選，來接收符合特定準則的郵件。
- *轉送*提供雙向通訊。 不同於佇列，主題轉送不會儲存 「 執行中 」 郵件 it 的不是代理人。 不過，它只傳遞到目標應用程式。
- *事件集線器*低延遲與高可靠性提供大量的小數位數，在雲端的事件與遙測輸入。

當您建立佇列、 主題、 轉接 」 或事件] 中心內時，您指定的名稱。 合併與任何您稱為您的命名空間，此名稱將會建立物件的唯一識別碼。 應用程式可以提供服務匯流排，此名稱，然後使用該佇列中、 主題、 轉接 」 或事件中心之間的通訊。 

若要使用任何這些物件，Windows 應用程式可以使用 Windows Communication Foundation (WCF)。 佇列、 主題及事件集線器視窗的應用程式也可以使用服務匯流排定義訊息的 Api。 若要讓這些物件更好用的非 Windows 應用程式，Microsoft 提供 Sdk Java、 Node.js，以及其他語言。 您也可以存取佇列主題，以及使用 REST Api 透過 HTTP 事件集線器。 

請務必瞭解的即使服務匯流排本身就會執行在雲端 (也就是 Microsoft Azure 資料中心的)，使用該應用程式，可以執行任何位置。 您可以使用服務匯流排連線，例如 Azure 上執行應用程式或您自己的資料中心內所執行的應用程式。 您也可以使用其 Azure 或另一個上執行應用程式連接雲端平台與內部部署應用程式或電話與平板電腦。 即使可中央的應用程式或另一連線家庭就、 感應器和其他裝置。 服務匯流排是在雲端，可以從幾乎任何位置存取一般通訊機制。 您使用的方式，取決於您的應用程式需要執行。


## <a name="queues"></a>佇列

假設您決定要連接兩個使用服務匯流排佇列中的應用程式。 [圖 2](#Fig2)說明這種情況。

<a name="Fig2"></a>![服務匯流排佇列的圖表][queues]
 
**圖 2︰ 單向非同步佇列提供服務匯流排佇列。**

程序很簡單︰ 寄件者傳送給服務匯流排佇列中的郵件，並接收者挑選於稍後的郵件。 佇列可以有只單一收件者，[圖 2](#Fig2)顯示為或多個應用程式可以從相同的佇列讀取。 在第二個的情況下，每一封郵件已讀取只要接收者的多重轉換服務您應該改用主題。

每一封郵件中有兩個部分︰ 一組常用屬性，每個機碼/值組，以及二進位郵件本文。 正在使用的方式取決於應用程式嘗試執行。 例如，在傳送郵件最近銷售活動的相關應用程式可能會包含屬性*銷售者 = 「 Ava 」*和*量 = 10000*。 郵件本文可能包含銷售簽署合約的掃描的圖像或者，如果沒有，只保留空白。

收件者可以讀取服務匯流排佇列中郵件的兩個不同的方式。 第一個選項，稱為*ReceiveAndDelete*，移除佇列中的郵件，並立即刪除。 這是簡單，但結束處理郵件前，當機收件者，如果郵件將會遺失。 因為它從佇列中移除，沒有其他收件者可以存取的地方。 

第二個選項，也就是*PeekLock*，是用來協助解決這個問題。 ReceiveAndDelete，例如 PeekLock 讀取會移除佇列中的郵件。 它不會刪除的郵件，不過。 不過，它會鎖定訊息，讓其他接收者，原本看不見，然後等待三個事件之一︰

- 如果收件者已成功處理郵件，它會撥打*完成*，，並佇列中刪除的郵件。 
- 如果收件者會決定，無法順利處理郵件，它會呼叫*放棄*。 佇列中然後移除鎖定訊息，並可讓其他接收器。
- 如果收件者的通話兩者的這些設定一段時間內 （依預設，60 秒），佇列中假設接收者失敗。 在此情況下，它看起來像是收件者有稱為別抱任何，讓郵件可以使用其他接收器。

請注意以下會發生什麼情況︰ 相同的郵件可能會傳送兩次，可能是給兩種不同的接收器。 使用服務匯流排佇列應用程式必須的準備。 若要更輕鬆地重複偵測，每一封郵件都有唯一的訊息屬性的預設保持相同的方式無論多次佇列中讀取訊息。 

佇列是很多情況中非常有用。 它們可以讓應用程式通訊偶數時同時執行非同時，尤其是方便批次與行動應用程式的項目。 使用多個接收器佇列中也會提供自動負載平衡，由於已傳送的郵件會分散到這些接收器。


## <a name="topics"></a>主題

因為它們是很有用，佇列不一定正確的方案。 有時候，服務匯流排主題會更好。 [圖 3](#Fig3)說明此概念。

<a name="Fig3"></a>![服務匯流排主題和訂閱的圖表][topics-subs]
 
**圖 3︰ 根據訂閱的應用程式所指定的篩選時，其可接收部分或所有服務匯流排主題傳送的郵件。**

主題是多種方式來佇列中類似。 主題相同的方式來提交佇列中，郵件和這些郵件的寄件者送出郵件看起來與佇列。 顯示較大的差別主題讓每個接收的應用程式定義*篩選*來建立自己的訂閱。 訂閱者然後只會看到訊息，符合該篩選。 例如，[圖 3](#Fig3)顯示寄件者和有三個訂閱者，主題都有它自己的篩選︰

- 訂閱者 1 會收到包含屬性的郵件*銷售者 = 「 Ava 」*。
- 訂閱者 2 接收郵件包含屬性*銷售者 = 」 並列文字 」* ，及/或包含的值大於 100000*量*屬性。 可能是 [注音標示的銷售管理員，而，因此她想要同時查看自己的銷售與無論誰建立的所有大銷售。
- 訂閱者 3 已經設定其篩選器*，則為 True*，表示它會收到所有郵件。 例如，此應用程式可能會負責維護稽核記錄，因此需要查看所有郵件。

就跟佇列主題訂閱者可以閱讀使用 ReceiveAndDelete 或 PeekLock 的郵件。 不同於佇列，不過，單一郵件傳送給主題可接收多個訂閱者。 多個應用程式可能會感興趣的相同的郵件時，此方法通常稱為*發佈及訂閱*，相當實用。 定義正確的篩選，每個訂閱者可以善用訊息資料流，以便查看部分。


## <a name="relays"></a>轉送

同時佇列 」 和 「 主題提供透過代理人的單向同步通訊。 流量流向只要方向，而且沒有寄件者及接收者之間沒有直接關聯。 但如果您不想此？ 假設您的應用程式需要傳送和接收訊息，或可能是您想要它們之間的直接連結，您不需要儲存郵件的代理人。 例如，地址案例服務匯流排提供轉送，[圖 4](#Fig4)顯示。

<a name="Fig4"></a>![服務匯流排轉送的圖表][relay]
 
**圖 4︰ 服務匯流排轉送提供應用程式之間的同步、 雙向通訊。**

詢問轉送明顯的問題是︰ 為什麼要使用其中一個？ 即使需要佇列，為什麼進行通訊透過雲端服務而非只直接互動的應用程式？ Answer （回應），是指直接可以比想像。

假設您想要連接兩個內部部署應用程式，同時執行公司的資料中心內。 每個這些應用程式位於後面的防火牆，且每個資料中心可能使用網路位址轉譯 (NAT)。 防火牆封鎖了傳入的資料上所有的連接埠、 和 NAT 表示每一個應用程式執行的電腦沒有固定您連絡直接從外部資料中心的 IP 位址。 一些額外的說明，不透過公用網際網路連線這些應用程式是問題。

服務匯流排轉送提供說明。 若要透過轉送的雙向通訊，每個應用程式會建立與服務匯流排輸出 TCP 連線，然後保持開啟狀態。 兩個應用程式之間的所有通訊會都通過這些連線。 從已建立每個連接的資料中心內，因為防火牆可讓每個應用程式的連入流量，但不開啟新的連接埠。 此方法也會取得問題的 NAT，因為整個通訊雲端中的每個應用程式已經一致的結束點。 應用程式可以交換透過轉送的資料，避免，否則通訊難以解決問題。 

若要使用服務匯流排轉送，應用程式會使用 Windows Communication Foundation (WCF)。 服務匯流排提供 WCF 繫結，可讓您直接透過轉送互動的 Windows 應用程式。 已使用 WCF 應用程式，可以通常只指定這些繫結，其中一項，然後透過轉送彼此通話。 不同於佇列和主題，不過，使用非 Windows 應用程式時可能，從轉送需要一些程式設計投入;標準的文件庫會提供。

不同於佇列和主題，應用程式不明確建立轉送。 不過，當想將接收訊息的應用程式建立 TCP 連線的服務匯流排，轉送會自動建立。 連線中斷，就會刪除轉送。 若要讓應用程式找出所建立的特定接聽轉接，服務匯流排會提供可讓應用程式名稱來尋找特定的轉送登錄。

轉送是正確的方案，當您需要直接應用程式之間的通訊。 例如，請考慮在必須從存回 kiosk、 行動裝置及其他電腦存取內部部署資料中心中執行的航空公司保留系統。 所有這些系統上執行應用程式可能依賴進行通訊，雲端服務匯流排轉送，可能執行的地方。

## <a name="event-hubs"></a>事件集線器

事件集線器是 free ingestion 系統，可以程序數百萬秒的事件時，啟用您的應用程式 [處理程序及分析大量資料所產生的連線的裝置及應用程式。 例如，您可以使用事件中樞的汽車艦隊收集即時引擎效能資料。 一旦收集到事件集線器，您可以轉換，並使用任何即時分析提供者或儲存空間叢集儲存資料。 如需有關事件集線器的詳細資訊，請參閱[事件集線器概觀][]。

## <a name="summary"></a>摘要

連接的應用程式一直建置完整的解決方案的組件，需要應用程式及服務彼此案例的範圍設定為 [增加為更多應用程式並連線到網際網路的裝置。 要達到這個透過佇列主題、 轉送，以及事件集線器提供雲端技術，服務匯流排旨在實作更容易且更多人使用，讓此重要的函數。

[svc-bus]: ./media/hybrid-solutions/SvcBus_01_architecture.png
[queues]: ./media/hybrid-solutions/SvcBus_02_queues.png
[topics-subs]: ./media/hybrid-solutions/SvcBus_03_topicsandsubscriptions.png
[relay]: ./media/hybrid-solutions/SvcBus_04_relay.png
[事件集線器概觀]: https://msdn.microsoft.com/library/azure/dn836025.aspx
