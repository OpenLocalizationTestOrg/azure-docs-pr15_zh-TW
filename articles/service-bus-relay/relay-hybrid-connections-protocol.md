<properties 
    pageTitle="Azure 轉送混合式連線通訊協定 |Microsoft Azure"
    description="zure 轉送混合式連線通訊協定指南。"
    services="service-bus"
    documentationCenter="na"
    authors="clemensv"
    manager="timlt"
    editor="tysonn" />
<tags 
    ms.service="service-bus"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="na"
    ms.date="10/28/2016"
    ms.author="sethm" />

# <a name="azure-relay-hybrid-connections-protocol"></a>Azure 轉送混合式連線通訊協定

Azure 轉送是一種 Azure 服務匯流排平台的重要功能核心。 轉送的新的 「 混合式連線 」 功能會根據 HTTP 和 WebSockets 安全的開啟通訊協定功用。

它會取代先前，平均名為建置基礎專屬通訊協定的 「 Biztalk 」 功能。 混合式連線整合 Azure 應用程式服務會繼續作為-是。

「 混合式連線 」 可讓您建立兩個網路應用程式，也就是下列其中一項或兩個合作對象可能位於 Nat 或防火牆後之間的雙向的二進位資料流通訊。

這份文件將說明與混合式連線轉送來連接接聽和寄件者的角色和接聽如何接受新連線的用戶端的用戶端互動。

## <a name="interaction-model"></a>互動模型

混合式連線轉送連線雙方提供側翼點，在 Azure 的同時廠商來探索及觀點自己的網路連線至雲端。 在 Api，還有 Azure 入口網站中該側翼點稱為這和其他的文件中的 「 混合式連線]。 混合式連線服務端點會稱為 「 服務 」 這份文件的其餘部分。

互動模型依賴許多其他網路 Api 所建立的術語︰

有的第一次指出整備處理連入連線，就會接受這些到達時接聽程式。 在另一側，沒有連接的用戶端連線接聽程式，必須是接受建立的雙向通訊路徑的連線。 「 連接 「，」 接聽 」、 「 接受 」 相同的條件，您會發現大部分通訊端 Api。

任何轉送的通訊模型具有輸出連線向服務端點，能讓您 「 接聽 」 也 「 客戶 」 colloquial 使用，也可能會造成其他術語多載; [廠商我們因此使用混合式連線的精確術語如下所示︰

雙面連線的程式稱為 「 用戶端]，因為它們是用戶端服務。 等待並接受連線的用戶端 「 接聽 」 或稱為 「 接聽角色]。 啟動新連線透過服務的接聽根據用戶端稱為 「 寄件者 」 或 「 寄件者角色]。

## <a name="listener-interactions"></a>接聽程式的互動行為

接聽有四個互動服務;所有的線上詳細資料稍後將此文件，在 [參照] 區段中說明。

### <a name="listen"></a>聆聽

若要指出服務接聽的整備準備好接受連線，它會建立輸出的 web 通訊端連線。 連線交換攜帶設定轉送命名空間和安全性權杖的權限來授予 「 接聽 」 的名稱中的混合式連線的名稱。 當 web 通訊端接受服務時，註冊完成，而且既有的 web 通訊端存留為啟用所有後續互動的 「 控制頻道 」。 服務可在混合式部署連線，讓最多 25 同時接聽。 如果有 2 或更多作用中的接聽程式，請連入連線會平衡在它們之間隨機順序。不保證展覽通訊群組。

### <a name="accept"></a>接受

每當寄件者開啟新的服務的連線設定時，會挑選及通知其中一個混合式連線的作用中接聽的服務。 會傳送通知給接聽透過控制開啟通道為 JSON 訊息包含接聽必須連接到接受連線的 Web 通訊端端點的 URL。

URL 也必須直接使用不含任何額外的工作; 接聽針對一段時間，基本上只要寄件者是願意，請等候連線會建立的端對端，但上限為 30 秒，才有效編碼的資訊。 URL 只能用於一個成功連線。 一旦建立側翼 url 的 Web 通訊端連線時，此 Web 通訊端上的所有進一步活動被轉送從和寄件者，沒有任何操作或服務的轉譯。

### <a name="renew"></a>更新 

接聽作用中時，必須使用登錄接聽和維護控制頻道安全性 token 可能過期。 Token 到期不會影響進行中的連線，但它會造成卸除服務或推出之後的到期立即控制頻道。 [更新] 筆勢是 JSON 訊息接聽可以傳送郵件給取代控制頻道，相關聯的權杖，以便控制頻道可以維護長時間。

### <a name="ping"></a>偵測 （ping) 

如果控制頻道保持閒置一段時間的方式，媒介例如負載平衡器或 Nat 可能卸除 TCP 連線。 「 偵測 （ping） 」 筆勢可避免，藉由傳送少量的資料上提醒的網路路由，連接用來作為運作，，它也可以做為 liveness 測試接聽程式中的每個人的頻道。 如果偵測 （ping） 失敗，請控制頻道被視為無法使用，並接聽應該重新連線。

## <a name="sender-interaction"></a>寄件者互動

寄件者僅有與服務的單一互動，它會連接。

### <a name="connect"></a>連線

「 連接 」 筆勢開啟 Web 通訊端服務，提供混合式連線名稱和 （選擇性的但所需的預設值） 的安全性 token 賦予查詢字串中的 「 傳送 」 權限。 隨後互動方式上述接聽及有建立會加入與此 Web 通訊端側翼連線接聽程式服務。 已接受的 Web 通訊端之後，所有進一步的互動 Web 通訊端因此會連線接聽程式。

## <a name="interaction-summary"></a>摘要的互動

此互動模型的結果為寄件者的用戶端是透過 「 清理 」 Web 通訊端的已連線至接聽程式，並且需要沒有進一步 preambles 或準備交換登出。 這個選項可讓幾乎任何現有 Web 通訊端用戶端實作輕易地利用混合式連線服務只要將其 Web 通訊端用戶端層提供正確建構的 URL。

側翼連線接聽取得透過接受互動的 Web 通訊端同時也是初始狀態，並且可以交給任何現有 Web 通訊端伺服器實作與架構的區域網路接聽項上的 [接受] 作業和混合式連線遠端 [接受] 作業會區別一些最小額外抽象。

## <a name="protocol-reference"></a>通訊協定參照

本節說明上述的通訊協定互動的詳細資料。

Web 通訊端建立所有連線的連接埠 443 升級為 HTTPS 1.1 （英文），通常的部分網頁通訊端架構或 API 抽象從。 以下描述會保留實作中性，而不建議特定架構。

## <a name="listener-protocol"></a>接聽通訊協定

接聽通訊協定包含兩個連接筆勢和三個訊息作業。

### <a name="listener-control-channel-connection"></a>接聽控制頻道連線

控制頻道開啟建立的 Web 通訊端連線︰

*wss: / / {命名空間地址} /**$servicebus**/* *hybridconnection /**{路徑}？ sb hc 動作 =...與 sb hc 識別碼 =...與 sb hc 權杖 =...」*

*命名空間地址*是 Azure 轉送命名空間裝載混合式部署連線，通常是表單的完整的網域名稱 {*myname}。 servicebus.windows.net。*

查詢字串參數選項如下所示

| 參數        | 需要？ | 描述                                                                                                                                                                                        |
|--------------|-----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| sb hc 動作 | [是]       | 接聽角色的參數必須**sb hc 動作 = 接聽**                                                                                                                                |
| {路徑}       | [是]       | 預先設定混合式連線上註冊此接聽 URL 編碼的命名空間路徑。 此運算式會附加至固定***$servicebus**/**hybridconnection /** * 路徑部分。 |
| sb hc 權杖  | [是]\*     | 接聽必須提供有效、 URL 編碼服務匯流排共用存取權杖命名空間或原樣**聆聽**右邊的混合式連線。                                           |
| sb hc 識別碼     | 無        | 此用戶端提供的選用 ID 可讓端對端診斷追蹤。                                                                                                                             |

如果 Web 通訊端連線失敗，因為未註冊，混合式連線路徑或無效或遺漏的權杖或其他錯誤，請將使用一般的 HTTP 1.1 （英文） 狀態的意見反應模型提供錯誤意見反應。 狀態描述會包含錯誤追蹤識別碼的 Azure 支援進行通訊︰

| 程式碼 | 錯誤          | 描述                                                            |
|------|----------------|------------------------------------------------------------------------|
| 404  | 找不到      | 混合式連線**路徑**不正確或基底 URL 格式不正確 |
| 401  | 未獲授權   | 安全性權杖會遺失或不正確或不正確                  |
| 403  | 禁止      | 安全性權杖不是有效值此動作的路徑          |
| 500  | 內部錯誤 | 發生錯誤服務                                    |

如果 Web 通訊端連線刻意關閉服務之後，一開始設定，這樣會使用適當 Web 通訊端通訊協定錯誤碼以及也會包含追蹤識別碼描述性的錯誤訊息傳遞的原因。 服務會關閉控制頻道不會遇到錯誤狀況。 任何關機是控制的用戶端。

| WS 狀態 | 描述                                                                        |
|-----------|------------------------------------------------------------------------------------|
| 1001      | 已刪除的郵件或停用的混合式連線路徑。                           |
| 1008      | 安全性權杖已過期，因此違反授權原則。 |
| 1011      | 發生錯誤內服務。                                           |

### <a name="accept-handshake"></a>接受信號 

接受通知服務接聽透過先前建立的控制項通道為 JSON 訊息 Web 通訊端文字框架中。 沒有這封郵件的回覆。

郵件包含 JSON 物件名為 「 接受 」，這次定義下列屬性︰

-   **地址**– 用來接受連入連線來建立 Web 通訊端服務的 URL 字串。

-   **識別碼**– 此連線的唯一識別碼。 如果寄件者的用戶端所提供的識別碼，則寄件者提供的值，否則系統產生的值。

-   **connectHeaders** – 寄件者，其中也包括 Sec WebSocket Protocol 和擴充 WebSocket Sec 功能標頭提供轉送端點的所有 HTTP 標頭。

| 接受訊息                                                                     |
|------------------------------------------------------------------------------------|
```json
{                                                                                  
    "accept" : {                                                                                    
        "address" : "wss://168.61.148.205:443/$servicebus/hybridconnection/{path}?...",                                                                          
        "id" : "4cb542c3-047a-4d40-a19f-bdc66441e736\_G0\_G1",                         
        "connectHeaders" : {                                                                
            "Host" : "…",                                                                       
            "Sec-WebSocket-Protocol" : "…",                                                     
            "Sec-WebSocket-Extensions" : "…"                                                    
        }                                                                                     
    }
}
```

提供 JSON 訊息中的地址 URL 由接聽程式用於建立 Web 通訊端接受或拒絕寄件者通訊端。

#### <a name="accepting-the-socket"></a>接受通訊端

若要接受，接聽程式建立的 WebSocket 連接至提供的地址。

請記住預覽期間的地址 URI 可能會使用不包裝的 IP 位址和伺服器所提供的 SSL 憑證，將無法驗證的地址。 這會修正期間預覽。

如果 「 接受 」 的訊息執行 「 Sec WebSocket-通訊協定 」 標題，預期接聽會只接受 WebSocket 支援的通訊協定，而且其設定的標頭，為建立 WebSocket。

相同適用於 「 Sec WebSocket-延伸模組 」 頁首。 如果架構支援副檔名，它應該設定頁首的所需的 「 Sec WebSocket-延伸模組 」 交換延伸的*伺服器*端回覆。

URL 做為-適用於建立接受通訊端，但是包含下列參數︰

| 參數        | 需要？ | 描述                                                                                                                                                                                                                                                                                   |
|--------------|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| sb hc 動作 | [是]       | 接受端的參數必須**sb hc 動作 = 接受**                                                                                                                                                                                                                          |
| {路徑}       | [是]       | 預先設定混合式連線上註冊此接聽 URL 編碼的命名空間路徑。 此運算式會附加至固定***$servicebus**/**hybridconnection /** * 路徑部分。                                                                                            
                                                                                                                                                                                                                                                                                                                           
                            The path expression MAY be extended with a suffix and a query string expression that follows the registered name after a separating forward slash.                                                                                                                                             
                                                                                                                                                                                                                                                                                                                           
                            This allows the sender client to pass dispatch arguments to the accepting listener when it is not possible to include HTTP headers.                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                           
                            The expectation is that the listener framework will parse out the fixed path portion and the registered name from the path and make the remainder, possibly without any query string arguments prefixed by “sb-“, available to the application for deciding whether to accept the connection.  
                                                                                                                                                                                                                                                                                                                           
                            For more detail see the “Sender Protocol” section below.                                                                                                                                                                                                                                       |
|sb hc 識別碼 |No        |請參閱**識別碼**上述的描述。                                                                                                                                                                                                                                                              |

如果發生錯誤時，服務，可能回應，如下所示︰

| 程式碼 | 錯誤          | 描述                         |
|------|----------------|-------------------------------------|
| 403  | 禁止      | URL 不正確。               |
| 500  | 內部錯誤 | 發生錯誤服務 |

在建立連線之後，伺服器會關閉 Web 通訊端時，或是使用下列的狀態，並關閉寄件者的 Web 通訊端

| WS 狀態 | 描述                                                                        |
|-----------|------------------------------------------------------------------------------------|
| 1001      | 寄件者的用戶端關閉連線                                        |
| 1001      | 已刪除的郵件或停用的混合式連線路徑。                           |
| 1008      | 安全性權杖已過期，因此違反授權原則。 |
| 1011      | 發生錯誤內服務。                                           |

#### <a name="rejecting-the-socket"></a>拒絕通訊端

拒絕通訊端後進行檢查的 「 接受 」 的訊息類似的交換需要狀態碼和狀態描述通訊拒絕的原因可以傳送回寄件者。

通訊協定選擇設計以下就是使用 WebSocket 交換 （也就設計用來在已定義之的錯誤的狀態結束），好讓接聽用戶端實作可以繼續依賴 WebSocket 用戶端和不需要採取額外、 答對 HTTP 用戶端。

若要拒絕通訊端，用戶端會從 「 接受 」 訊息的地址 URI，而例子兩個查詢字串參數︰

| 參數             | 需要？ | 描述                             |
|-------------------|-----------|-----------------------------------------|
| statusCode        | [是]       | 數字的 HTTP 狀態碼                |
| statusDescription | [是]       | 拒絕人力可讀的原因 |

產生 URI 然後用來建立 WebSocket 連線。還是一樣，請記住，SSL 憑證可能不相符的地址期間預覽中，讓驗證可能會停用。

當完成正確，此交換會刻意失敗 HTTP 錯誤碼 410，因為沒有 WebSocket 已建立。 如果發生錯誤，以下是選項︰

| 程式碼 | 錯誤          | 描述                         |
|------|----------------|-------------------------------------|
| 403  | 禁止      | URL 不正確。               |
| 500  | 內部錯誤 | 發生錯誤服務 |

### <a name="listener-token-renewal"></a>接聽 token 更新

時接聽的權杖即將過期，就可以透過建立的控制頻道服務傳送簡訊圖文框來取代。 郵件包含 JSON 物件名為 「 renewToken 」，這次定義下列屬性︰

-   **權杖**– 有效、 URL 編碼服務匯流排共用存取權杖命名空間或原樣**聆聽**右邊的混合式連線。

| renewToken 訊息                                                                                                                                                    
|------------------------------------------------------------------------------------------------|
```json
{
    "renewToken" : {      
        "token" : "SharedAccessSignature sr=http%3a%2f%2fcontoso.servicebus.windows.net%2fHybridConnection1%2f&amp;sig=XXXXXXXXXX%3d&amp;se=1471633754&amp;skn=SasKeyName"
    }                                                                                                                                                            
}
```                                                                                                                                                                      

如果權杖驗證失敗，存取，雲端服務將會關閉錯誤與控制項頻道 websocket，否則就沒有回覆。

| WS 狀態 | 描述                                                                        |
|-----------|------------------------------------------------------------------------------------|
| 1008      | 安全性權杖已過期，因此違反授權原則。 |

<a name="sender-protocol"></a>寄件者通訊協定
---------------

寄件者通訊協定相當有效如何建立接聽程式。 目標是端對端 Web 端的最大的透明度。 連線至的地址接聽程式，與相同，但 」 動作 」 不同，並權杖需要不同的權限︰

*wss: / / {命名空間地址} /**$servicebus**/* *hybridconnection /**{路徑}？ sb hc 動作 =...與 sb hc 識別碼 =...\[與單一位元組字元 hc 權杖 =...\]*

*命名空間地址*是 Azure 轉送命名空間裝載混合式部署連線，通常是表單的完整的網域名稱 {*myname}。 servicebus.windows.net。*

要求可能會包含任何額外的 HTTP 標題，包括應用程式定義的。 所提供的所有標題流向接聽程式，才可以 「 connectHeader 「 物件的 [接受] 的 [控制] 訊息。

查詢字串參數選項如下所示

| 參數        | 需要？ | 描述                                                                                                                                                                                                       |
|--------------|-----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| sb hc 動作 | [是]       | 接聽角色的參數必須**動作 = 連線**                                                                                                                                                    |
| {路徑}       | [是]       | 預先設定混合式連線上註冊此接聽 URL 編碼的命名空間路徑。                                                                                                               
                                                                                                                                                                                                                                               
                            The path expression MAY be extended with a suffix and a query string expression to communicate further                                                                                                             
                                                                                                                                                                                                                                               
                            If the Hybrid Connection is registered under the path “hyco”, the path expression can be “**hyco/**suffix?param=value&…” followed by the query string parameters defined here. A complete expression may then be:  
                                                                                                                                                                                                                                               
                            *wss://{ns}/**$servicebus**/**hybridconnection/*** **hyco/**suffix?param=value*& sb-hc-action=…&sb-hc-id=…\[&sbc-hc-token=…\]*                                                                                     
                                                                                                                                                                                                                                               
                            The path expression is passed through to the listener in the address URI contained in the “accept” control message.                                                                                                |
|sb hc 權杖 |Yes\*     |接聽必須提供有效、 URL 編碼服務匯流排共用存取權杖命名空間或原樣**傳送**右邊的混合式連線。                                                            | |sb hc 識別碼 |No        |選用的識別碼，允許端對端診斷追蹤，並可供接聽接受交換期間。                                                                                       |

如果 Web 通訊端連線失敗，因為未註冊，混合式連線路徑或無效或遺漏的權杖或其他錯誤，請將使用一般的 HTTP 1.1 （英文） 狀態的意見反應模型提供錯誤意見反應。 狀態描述會包含錯誤追蹤識別碼的 Azure 支援進行通訊︰

| 程式碼 | 錯誤          | 描述                                                            |
|------|----------------|------------------------------------------------------------------------|
| 404  | 找不到      | 混合式連線**路徑**不正確或基底 URL 格式不正確 |
| 401  | 未獲授權   | 安全性權杖會遺失或不正確或不正確                  |
| 403  | 禁止      | 安全性權杖不是有效值此動作的路徑          |
| 500  | 內部錯誤 | 發生錯誤服務                                    |

如果 Web 通訊端連線刻意關閉服務之後，一開始設定，這樣會使用適當 Web 通訊端通訊協定錯誤碼以及也會包含追蹤識別碼描述性的錯誤訊息傳遞的原因。

| WS 狀態 | 描述                                                                        |
|-----------|------------------------------------------------------------------------------------|
| 1000      | 接聽關閉通訊端。                                                 |
| 1001      | 已刪除的郵件或停用的混合式連線路徑。                           |
| 1008      | 安全性權杖已過期，因此違反授權原則。 |
| 1011      | 發生錯誤內服務。                                           |

## <a name="next-steps"></a>後續步驟︰

- [轉送常見問題集](relay-faq.md)
- [建立命名空間](relay-create-namespace-portal.md)
- [開始使用.NET](relay-hybrid-connections-dotnet-get-started.md)
- [快速入門節點](relay-hybrid-connections-node-get-started.md)