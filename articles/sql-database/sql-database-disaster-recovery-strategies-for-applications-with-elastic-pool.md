<properties 
   pageTitle="使用 SQL 資料庫地理複製損毀修復設計雲端解決方案 |Microsoft Azure"
   description="瞭解如何設計您的雲端解決方案損毀修復選擇正確的容錯移轉模式。"
   services="sql-database"
   documentationCenter="" 
   authors="anosov1960" 
   manager="jhubbard" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA" 
   ms.date="07/16/2016"
   ms.author="sashan"/>

# <a name="disaster-recovery-strategies-for-applications-using-sql-database-elastic-pool"></a>使用 SQL 資料庫彈性資料庫的應用程式損毀修復策略 

我們的學習成果，雲端服務並不容易和嚴重事件年也會發生這種情形。 SQL 資料庫提供功能，提供的業務連續性，您的應用程式，這些事件發生時數的字。 [彈性的資料庫](sql-database-elastic-pool.md)及獨立資料庫支援相同類型的損毀修復功能。 本文將說明數種 DR 策略的彈性集區的運用這些 SQL 資料庫 business 連續性功能。

基於的本文中，我們將使用標準 SaaS ISV 應用程式的模式︰

<i>現代化的雲端基礎的每位使用者的 web 應用程式提供一個 SQL 資料庫。ISV 有大量的客戶，因此會使用許多資料庫，稱為 [租用戶資料庫。租用戶資料庫通常有發生無法預期的活動模式，ISV 因為彈性的資料庫在長時間，讓資料庫成本非常如預期呈現。彈性的資料庫也可簡化效能管理，當使用者活動暫停。除了租用戶資料庫應用程式也會使用數種資料庫管理使用者設定檔，安全性、 收集使用模式等。個別的租用戶的可用性不會影響整體的應用程式的可用性。不過，可用性及管理資料庫的效能非常重要的應用程式的函數，且管理資料庫的離線整個應用程式是否離線。</i>  

在紙張的其餘部分中，我們將討論涵蓋案例從嚴格可用性需求的成本機密啟動應用程式範圍的 DR 策略。  

## <a name="scenario-1-cost-sensitive-startup"></a>情況 1。 成本機密啟動

<i>我啟動商務，而且正在太成本機密。 我要簡化部署及管理應用程式的我願意有有限的 SLA 的個別的客戶。但我想要為整個絕不會是離線，確保應用程式。</i>

若要滿足簡單的需求，您應該將所有的租用戶資料庫部署到您所選擇的 Azure 區域中的一個彈性資料庫，並部署地理複寫獨立資料庫以管理資料庫。 針對租用戶損毀修復，使用地理-還原，會出現搭售。 若要確保可使用管理資料庫]，則應該地理複製到另一個區域 （步驟 1）。 在這個案例中損毀復原設定進行中的成本等於次要資料庫的總成本。 在下一個圖表說明這項設定。

![圖 1](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-1.png)

若主要區域中的資料，以顯示您的應用程式線上修復步驟說明的下一個圖表。

- 立即容錯移轉管理資料庫 (2) DR 區域。 
- 變更為指向的 DR 地區的應用程式的連線字串。 DR 區域中，將會建立所有新的帳戶和租用戶資料庫。 現有客戶，會看到他們暫時無法使用的資料。
- 建立與原始的集區 (3) 設定相同的彈性的資料庫。 
- 若要建立的租用戶複本資料庫 (4) 使用地理還原。 您可以考慮觸發個別還原的使用者連線，或使用一些其他應用程式特定的優先順序配置。

現在您的應用程式恢復連線 DR 區域，但某些客戶存取其資料時，會遇到的延遲。

![圖 2](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-2.png)

如果資料是暫時，則可能的 DR 地區所有還原都已完成之前，將會 Azure 復原的主要區域。 在此情況下，您應該協調移回的主要區域的應用程式。 程序會在下圖所示的步驟。
 
- 取消所有未完成的地理還原要求。   
- 容錯移轉的主要區域 (5) 來管理資料庫。 附註︰ 區域的復原後舊的主運算自動成為次要連結。 現在，將會再次切換角色。 
- 變更應用程式的連線字串，改為指向的主要區域。 現在所有新帳戶租用戶資料庫會建立主要區域中。 某些現有客戶會看到他們暫時無法使用的資料。   
- 設定為唯讀，以確保他們無法修改 DR 區域 (6) 中的 DR 集區中的所有資料庫。 
- 復原變更的 DR 集區中每個資料庫，重新命名或刪除主要資料庫 (7) 中對應的資料庫。 
- 複製 DR 資料庫的更新的資料庫至主要的資料庫 (8)。 
- 刪除 DR 資料庫 (9)

現在您的應用程式會在線上租用戶中所有資料庫可用主要資料庫與主要區域中。

![圖 3](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-3.png)

主要**優點**此策略的是資料層重複低進行中的成本。 SQL 資料庫服務沒有應用程式重新寫入與搭售自動進行備份。  還原彈性的資料庫時才，是所產生的成本。 **取捨**是租用戶的所有資料庫完整修復帶大量的時間。 它會根據總還原會開始 DR 區域中的數字及租用戶資料庫的整體大小。 即使您在其他人優先順序一些租用戶還原，將競爭所有其他還原，因為服務會仲裁，最小化對現有客戶的資料庫的整體影響節流會啟動相同的區域。 此外，復原租用戶的資料庫才能開始建立新的彈性集區 DR 區域中。

## <a name="scenario-2-mature-application-with-tiered-service"></a>案例 2。 成熟分層服務應用程式 

<i>我可以分層的服務優惠與不同 Sla 試用版客戶，以及支付客戶的成熟 SaaS 應用程式。試用版的客戶，我有減少盡可能成本。試用版的客戶可採取停機時間，但我想要減少的可能性。付費的客戶，任何停機時間的航班風險。所以我要確認該支付客戶都可以存取其資料。</i> 

若要支援這種情況下，您應該將它們放到不同的彈性集區與付費的租用戶分開試用的租用戶。 試用版客戶，會有較低 eDTU 每個租用戶和低 SLA 復原較長的時間。 每個租用戶和較高的 SLA 較高的 eDTU 集區就會付費的客戶。 若要確保最低復原時間，請付費的客戶租用戶資料庫應地理複寫。 在下一個圖表說明這項設定。 

![圖 4](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-4.png)

第一種情況，例如，以便您可以使用獨立的地理複製的資料庫，(1) 會相當作用中管理資料庫。 這樣就能確定如預期呈現效能的新客戶訂閱、 更新設定檔及其他管理作業。 管理資料庫的主運算存放的地區會在主要區域，，管理資料庫的次要連結讓它們的地區會 DR 區域。

付費的客戶租用戶資料庫會佈建在主要區域中的 「 付費 」 集區中有作用中的資料庫。 您應該佈建同名的 DR 區域中的次要集區。 每個租用戶應地理複製至第二個資料庫 (2)。 這樣會啟用所有使用容錯移轉的租用戶資料庫的快速復原。 

如果中斷發生的主要區域中，以顯示您的應用程式線上修復步驟會說明在下一個圖表中︰

![圖 5](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-5.png)

- 立即容錯管理資料庫 DR 區域 (3)。
- 變更為指向的 DR 地區的應用程式的連線字串。 現在所有新帳戶租用戶資料庫會建立 DR 區域中。 現有的試用版客戶，會看到他們暫時無法使用的資料。
- 容錯移轉至立即還原連絡人的顯示狀態 (4) 的 DR 區域中的資料庫的付費租用戶的資料庫。 由於容錯移轉快速中繼資料層級的變更，您可能會考慮的最佳化個別的容錯移轉，視需要觸發由使用者連線。 
- 如果您的第二個資料庫 eDTU 大小是低於主要，因為次要資料庫只需要處理變更記錄時，所以次要連結容量，您應該立即增加現在集區容量以容納所有租用戶 (5) 的最大的工作量。 
- 建立新的彈性集區相同的名稱與試用版客戶的資料庫 (6) 的 DR 區域中相同的設定。 
- 試用版客戶的集區建立之後，可用於地理還原將個別的試用承租人資料庫還原到新的資料庫 (7)。 您可以考慮觸發個別還原的使用者連線，或使用一些其他應用程式特定的優先順序配置。

此時應用程式中的 DR 地區已恢復連線。 試用版客戶，會發生延遲時存取其資料, 時，所有付費客戶會有其資料的存取權。

當已復原的主要區域 Azure*之後*，您還原您可以繼續執行應用程式，在該區域的 DR 區域中的應用程式，或您可以決定要回復至主要的區域。 如果主要區域復原*之前*已完成容錯移轉程序，您應該立即考慮失敗的上一步]。 回復會採取步驟下圖所示︰ 
 
![圖 6](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-6.png)

- 取消所有未完成的地理還原要求。   
- 容錯移轉管理資料庫 (8)。 之後的地區復原舊的主要自動變得次要。 現在就會變成主要一次。  
- 容錯付費的租用戶移轉資料庫 (9)。 同樣地之後的地區復原, 舊的主運算，都會自動成為次要連結。 現在就會再次變成主運算。 
- 設定還原已變更的 DR 地區中，為唯讀狀態 (10) 的試用版資料庫。
- 自復原變更的試用版客戶 DR 集區中每個資料庫，重新命名或刪除試用客戶主要資料庫 (11) 中對應的資料庫。 
- 複製 DR 資料庫的更新的資料庫至主要的資料庫 (12)。 
- 刪除 DR 資料庫 (13) 

> [AZURE.NOTE] 容錯移轉作業是非同步。 若要最小化的修復時間很重要您以批次至少 20 個資料庫執行租用戶資料庫的容錯移轉] 命令。 

主要**優點**此策略的是，提供高 SLA 付費的客戶。 也可保證新的試用版是解除封鎖，只要建立試用的 DR 集區。 **取捨**是此設定會增加租用戶資料庫的次要 DR 資料庫成本的總成本，用於付費的客戶。 此外，如果次要資料庫有不同的大小，付費的客戶會發生後移轉後的較低效能直到 DR 區域中的，資料庫升級完成。 

## <a name="scenario-3-geographically-distributed-application-with-tiered-service"></a>情況 3。 分散分層服務應用程式

<i>我有分層的服務優惠的成熟 SaaS 應用程式。我要提供給我付費的客戶的非常積極 SLA 甚至簡短中斷可能會導致客戶滿意度發生問題時，最小化的影響風險。這是關鍵的付費客戶隨時都可以存取他們的資料。免費試用版而 SLA 不提供試用期間。</i> 

支援這種情況，您應該有三個不同的彈性集區。 使用高 eDTUs 每個資料庫的兩個等於大小集區應該佈建後兩個不同的區域，以包含付費的客戶租用戶資料庫中。 包含試用的租用戶的第三個集區有較低 eDTUs 每個資料庫，並提供兩個區域的其中一種。

若要確保最低復原時間期間中斷付費的客戶租用戶資料庫應與 50%的主索引中的兩個區域的每個資料庫複寫地理。 同樣地，每個地區有 50%的次要資料庫。 這種方式如果區域是離線只 50%的付費的客戶的資料庫會影響，而且必須容錯移轉。 其他資料庫會維持不變。 此設定] 下圖所示︰

![圖 4](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-7.png)

與先前的案例中，因此您應該將其設定為獨立地理複寫資料庫 (1) 會相當作用中管理資料庫。 這樣就能確定如預期呈現新客戶訂閱、 更新設定檔及其他管理作業的效能。 區域的便是管理資料庫的主要區域和 B 的區域將會用於管理資料庫的復原。

付費的客戶租用戶資料庫會也地理複製，但主運算，次要連結置放地區 A 和 B (2) 區域。 租用戶主要資料庫而受到中斷這種方式可以容錯移轉至其他區域，然後才可供使用。 在不會影響租用戶資料庫的其他部分。 

下一步的圖表可圖解修復步驟才會中斷發生區域 a。

![圖 5](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-8.png)

- 立即失敗上的管理資料庫] 區域 B (3)。
- 變更為指向 [管理資料庫 b 修改，請確定區域 B，則會建立新的帳戶和租用戶資料庫與現有的租用戶資料庫，則會找到那里以及管理資料庫的區域中的應用程式的連線字串。 現有的試用版客戶，會看到他們暫時無法使用的資料。
- 容錯移轉至資料庫中要立即還原連絡人的顯示狀態 (4) 區域 B 2 付費租用戶的資料庫。 由於容錯移轉快速中繼資料層級的變更，您可能會考慮的最佳化個別的容錯移轉，視需要觸發由使用者連線。 
- 現在自資料庫 2 包含只有主要資料庫集區中的總工作量會增加，因此您應該立即放大其 eDTU (5)。 
- 建立新的彈性集區相同的名稱與試用版客戶的資料庫 (6) 的區域 B 中相同的設定。 
- 集區建立之後使用地理還原個別的試用承租人資料庫還原到資料庫 (7)。 您可以考慮觸發個別還原的使用者連線，或使用一些其他應用程式特定的優先順序配置。


> [AZURE.NOTE] 容錯移轉作業是非同步。 若要最小化的修復時間很重要您以批次至少 20 個資料庫執行租用戶資料庫的容錯移轉] 命令。 

現在您的應用程式位於恢復連線地區 b。試用版客戶，會發生延遲時存取其資料, 時，所有付費客戶會有其資料的存取權。

區域的已復原時，您必須決定是否您想要使用試用版的客戶或回復區域 a 使用試用版的客戶資料庫的地區 B一個準則可能的試用承租人資料庫後復原修改 %。 決定無論您必須重新平衡兩個集區之間付費的租用戶。 下圖說明程序，當試用承租人資料庫無法返回地區 a。  
 
![圖 6](./media/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool/diagram-9.png)

- 取消試用的 DR 資料庫所有未完成的地理還原要求。   
- 容錯移轉管理資料庫 (8)。 區域的復原後舊的主要已自動成為次要。 現在就會變成主要一次。  
- 選取資料庫會回到 (9) 其次要連結到資料庫 1 和啟動容錯移轉失敗的付費租用戶。 區域的復原後集區 1 中的所有資料庫會自動都變成次要連結。 現在 50%，它們會再次變成主運算。 
- 縮小資料庫 2 原始 eDTU (10)。
- 設定所有會還原為唯讀狀態 (11) 的區域 B 試用版的資料庫。
- 復原變更的試用版的 DR 集區中每個資料庫重新命名或刪除試用的主要資料庫 (12) 中對應的資料庫。 
- 複製 DR 資料庫的更新的資料庫至主要的資料庫 (13)。 
- 刪除 DR 資料庫 (14) 

這種方法的主要**優點**是︰

- 付費客戶，因為它可確保資料不會影響超過 50%的租用戶資料庫支援最高 SLA。 
- 可確保復原期間會建立的記錄 DR 資料庫時，會解除封鎖新的試用版。 
- 為 50%的集區 1 和 2 資料庫中的次要資料庫一定會較少使用中]，然後主要資料庫，它會允許更有效使用集區容量。

主要**折衷方案**包括︰

- 針對 [管理資料庫的 CRUD 作業會有較低的延遲使用者連線至區域 B 時將執行的主要管理資料庫的使用者連線至區域的比對。
- 需要更複雜的設計，管理資料庫。 例如，每一租用戶記錄必須具備需要變更期間錯誤移轉及回復位置標記。  
- 付費客戶區域 B 資料庫升級完成之後，可能會遇到較低的效能與平常不同。 

## <a name="summary"></a>摘要

本文著重於損毀復原的策略 SaaS ISV 多租用戶應用程式所使用的資料庫層。 您選擇的策略應該為基礎的應用程式，例如商務模型，而您想要提供給您的客戶，預算限制式等 SLA 需求... 每個所述的策略概述效益與取捨，讓您無法做出的決策。 此外，您的特定應用程式可能會包含其他 Azure 元件。 因此您應該檢閱其業務連續性指導方針，以及安排的資料庫層與其復原。 若要深入瞭解管理復原 Azure 中的資料庫應用程式，請參閱[損毀修復設計雲端方案](./sql-database-designing-cloud-solutions-for-disaster-recovery.md)。  


## <a name="next-steps"></a>後續步驟

- 若要進一步瞭解自動 Azure SQL 資料庫備份，請參閱[SQL 資料庫自動備份](sql-database-automated-backups.md)
- 業務連續性概觀與分析藍本，請參閱[業務連續性概觀](sql-database-business-continuity.md)
- 若要瞭解如何使用復原自動的備份，請參閱[還原在服務啟動備份資料庫](sql-database-recovery-using-backups.md)
- 若要深入了解更快速地復原選項，請參閱[作用地理複寫](sql-database-geo-replication-overview.md)  
- 若要瞭解如何使用自動的備份的封存，請參閱[資料庫複本](sql-database-copy.md)
