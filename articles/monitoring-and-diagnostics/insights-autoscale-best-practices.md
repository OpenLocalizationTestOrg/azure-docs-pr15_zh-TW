<properties
    pageTitle="Azure 監視器自動調整的最佳作法。 |Microsoft Azure"
    description="瞭解原則有效地使用 Azure 監視器 」 中的 [自動縮放。"
    authors="kamathashwin"
    manager="carolz"
    editor=""
    services="monitoring-and-diagnostics"
    documentationCenter="monitoring-and-diagnostics"/>

<tags
    ms.service="monitoring-and-diagnostics"
    ms.workload="na"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="10/20/2016"
    ms.author="ashwink"/>

# <a name="best-practices-for-azure-monitor-autoscaling"></a>Azure 監視器自動調整的最佳作法

下列各節文件中的可協助您瞭解自動調整大小的 Azure 的最佳作法。 這項資訊之後，您就可以更有效地使用 Azure 基礎結構中的 [自動調整大小。

## <a name="autoscale-concepts"></a>自動調整大小的概念

- 資源可以有只有*一個*自動縮放設定
- 自動調整大小設定可以有一或多個設定檔及每個設定檔可以有一或多個自動調整大小的規則。
- 自動調整大小設定縮放執行個體水平，這是*取出*增加的執行個體和*中*的執行個體數目。
 自動調整大小設定具備最大值、 最小值及預設值的執行個體。
- 自動調整大小的工作一律會讀取相關聯的公制縮放，檢查如果它有交叉向外或縮放比例中設定的臨界值。 您可以檢視清單的指標的自動調整大小可以縮放在[Azure 監視器自動縮放常見指標](insights-autoscale-common-metrics.md)。
- 所有臨界值的計算方式執行個體層級。 例如 「 小數位數縮小 1 的執行個體時計算平均值 CPU > 80%時執行個體計數為 2, 」，表示向外，所有執行個體之平均 CPU 大於 80%。
- 您一定會收到失敗通知，透過電子郵件。 具體來說，擁有人、 參與者及讀者目標資源的接收電子郵件。 您也都*復原*電子郵件時收到自動調整大小從無法復原，並開始正常運作。
- 您可以選擇加入集接收透過電子郵件和 webhooks 成功的縮放比例動作通知。

## <a name="autoscale-best-practices"></a>自動調整大小的最佳作法

當您使用 [自動調整大小，請使用下列最佳作法。

### <a name="ensure-the-maximum-and-minimum-values-are-different-and-have-an-adequate-margin-between-them"></a>確認最大值] 和 [最小值不同，而且有足夠的邊界，它們之間
如果您有最小值 = 2 的最大 = 2 且目前執行個體計數為 2，可能會發生任何縮放比例動作。 保留最大值和最小的執行個體計算，也就是 （含） 之間有足夠的邊界。 自動調整大小永遠縮放之間這些限制。

### <a name="manual-scaling-is-reset-by-autoscale-min-and-max"></a>手動調整重設自動調整大小 min 與 max
如果您手動更新的執行個體計算值高於或低於最大值，自動調整大小引擎會自動調整回 （如果下方） 的最小或最大值 （如果上方）。 例如，您可以設定 3 到 6 之間的範圍。 如果您有一個執行個體，自動調整大小引擎縮放到 3 的執行個體，在下次執行。 同樣地，它會比例增益集 8 的執行個體在下次執行備份到 6。  手動調整是非常暫時，除非您重設自動調整大小規則。

### <a name="always-use-a-scale-out-and-scale-in-rule-combination-that-performs-an-increase-and-decrease"></a>使用向外] 及 [縮放比例增益集的規則組合，增加和減少
如果您使用的組合只有一個組件時，自動縮放比例之增益集單一，或在直到最大值] 或 [最小值為止。

### <a name="do-not-switch-between-the-azure-portal-and-the-azure-classic-portal-when-managing-autoscale"></a>在管理自動調整大小時不 Azure 入口網站和 Azure 傳統入口網站之間切換
如需雲端服務與應用程式服務 （Web 應用程式），使用 Azure 入口網站 (portal.azure.com) 來建立和管理自動調整大小的設定。 虛擬機器縮放比例設定為使用 PoSH、 CLI 或 REST API 來建立和管理自動調整大小的設定。 不切換 Azure 傳統的入口網站 (manage.windowsazure.com) 和 Azure 入口網站 (portal.azure.com) 時管理自動調整大小的設定。 Azure 傳統入口網站和其基礎的後端有限制。 移至 Azure 入口網站管理使用圖形使用者介面的自動調整大小。 若要使用 [自動調整大小 PowerShell、 CLI 或 REST API （透過 Azure 資源檔案總管），就的選項。

### <a name="choose-the-appropriate-statistic-for-your-diagnostics-metric"></a>選擇適當的統計資料，而您診斷度量
診斷眼，您可以選擇*平均值*、*最小值*、*最大值*和*總*為度量單位，若要縮放的。 最常見的統計值為*平均*。

### <a name="choose-the-thresholds-carefully-for-all-metric-types"></a>選擇 [所有公制類型謹慎臨界值
建議您謹慎選擇不同的閾值向外] 及 [縮放比例集根據實用的情況。

我們*不建議使用*自動調整大小設定等的相同或非常類似臨界值的看]，並在條件範例如下︰

- 增加 1 的執行個體何時計算執行緒計數 < = 600
- 減少 1 的執行個體何時計算執行緒計數 > = 600

讓我們來看看範例，什麼可能會導致看起來似乎混亂的行為。 Cosider 下列程序。

1. 假設有 2 的執行個體的開頭，然後每個執行個體的對話的平均數目，會以 625。
2. 自動調整大小調整出新增第 3 個執行個體。
3. 接下來，假設的各執行個體的平均執行緒計算落在 575。
4. 前縮放比例向下、 自動調整大小嘗試估計的最終狀態會如果縮放中。 例如，575 x 3 （目前執行個體計數） = 1,725 / 2 （最後一個數字的執行個體時縮小） = 862.5 往來。 這表示必須立即擴充再次即使縮放，如果平均執行緒計數保持不變，或甚至落只有少量自動調整大小。 不過，如果其向上一次，整個程序會重複前置無限迴圈。
5. 若要避免 （稱為 「 拍打 」） 這種情況下，自動調整大小無法縮放向下完全。 不過，它會略過，並會重新評估的條件下一次執行服務的工作。 因為自動調整大小不會顯示為工作 575 平均執行緒計數時，這可能會造成混淆許多人。

若要避免 「 flappy 」 的情況下是期間小數位數的估計。 注意當您選擇擴充的相同臨界值和中，您應該保留此行為。

建議您選擇適當的邊界之間向外和臨界值。 例如，請考慮下列更好的規則組合。

- 增加 1 的執行個體何時計算 CPU %> = 80
- 減少 1 的執行個體何時計算 CPU %< = 60

在此情況下  

1. 假設有 2 的執行個體的起始。
2. 如果所有執行個體的平均 CPU %前往 80，自動調整大小調整出新增第三個執行個體。
3. 現在假設的一段時間的 CPU %落在 60。
4. 自動調整大小的小數位數的規則來估計的最終狀態，就好像比例集。 例如，60 x 3 （目前執行個體計數） = 180 / 2 （最後一個數字的執行個體時縮小） = 90。 因此，自動調整大小會不縮放比例增益集因為它必須擴充立即再次。 不過，它不會向下縮放比例。
5. 會檢查 [下一次自動調整大小，CPU 持續至 50。 它會評估一次-50 x 3 執行個體 = 150 / 2 執行個體 = 75，是下方的 80，延展閥值，因此其已成功縮放中 2 的執行個體。

### <a name="considerations-for-scaling-threshold-values-for-special-metrics"></a>縮放比例特殊的指標閾值的考量
 例如儲存空間或服務匯流排佇列長度公制特殊度量臨界值是郵件使用每個執行個體目前的數字的平均數目。 謹慎選擇選擇此公制的臨界值。

讓我們來說明以範例，以確保您了解更好的行為。

- 儲存佇列中的郵件數時執行個體增加 1 count > = 50
- 當儲存佇列中的郵件數執行個體減少 1 計數 < = 10

請考慮下列程序︰

1. 有 2 的儲存空間佇列中執行個體。
2. 郵件保留即將，並檢閱儲存佇列中，總計的讀取 50。 您可能認為該自動調整大小應該啟動延展的動作。 不過，請注意，您仍 50/2 = 25 每個執行個體的郵件。 因此，不會擴充。 第一個向外發生，總訊息中的字數統計儲存佇列中應該 100。
3. 接下來，假設總郵件計數到達 100。
4. 因為擴充動作加入第 3 的儲存空間佇列中執行個體。  下一個向外動作將不會發生直到總訊息中的字數統計佇列中達到 150，因為 150/3 = 50。
5. 現在佇列中的郵件數變小。 使用 3 個執行個體，第一個小數位數的動作時會發生所有佇列中的郵件總數加入最 30，因為 30/3 = 10 的郵件，每個執行個體，也就是比例閥值。

### <a name="considerations-for-scaling-when-multiple-profiles-are-configured-in-an-autoscale-setting"></a>縮放比例設定自動調整大小設定中的多個設定檔時的考量

在自動調整大小設定中，您可以選擇預設的設定檔，永遠套用沒有任何與排程或時間的相依性，或者您可以選擇週期性的設定檔或設定檔固定期間內的日期和時間範圍。

自動調整大小服務處理這些時，一律檢查以下列順序︰

1. 固定的日期設定檔
2. 週期性的設定檔
3. 預設 （永遠]） 設定檔

如果設定檔條件符合時，自動調整大小不會檢查其下的 [下一步] 設定檔條件。 自動調整大小只會處理一次一個設定檔。 這表示如果您想要也包含從較低層設定檔處理條件，您必須包含這些規則以及目前的設定檔中。

讓我們來檢閱此使用範例︰

下圖顯示自動調整大小設定預設的設定檔的最小的執行個體 = 2 和最大的執行個體 = 10。 在此範例中，規則延展訊息中的字數統計佇列中值大於 10 時已設定和縮放比例-佇列中的郵件計數時小於 3。 現在資源可以調整 2 到 10 的執行個體之間。

此外，還有星期一設定週期性檔。 設為最小的執行個體 = 2 和最大的執行個體 = 12。 這表示星期一，這種狀況，檢查有第一次自動調整大小的執行個體計數為 2，如果擴充至新的最小的 3。 只要自動調整大小持續尋找這個設定檔條件相符 （星期一），它只會處理 CPU 型比例出/中所設定的規則這個設定檔。 此時，它不會檢查佇列長度。 不過，如果您還想要檢查的佇列長度條件，您應該包含這些規則的預設設定檔以及星期一設定檔中。

同樣地時自動調整大小切換回預設設定檔，, 它會先檢查是否符合最小值和最大的條件。 如果同時執行個體數目 12，縮放中為 10，允許的預設設定檔的最大。

![自動調整大小的設定](./media/insights-autoscale-best-practices/insights-autoscale-best-practices.png)

### <a name="considerations-for-scaling-when-multiple-rules-are-configured-in-a-profile"></a>縮放設定的設定檔中的多個規則時的考量因素
在一些情況下，您可能必須在設定檔中設定多個規則。 服務使用設定多個規則時，會使用下列自動調整大小的規則集。

*延展*，如果符合任何規則，會執行自動調整大小。
*縮放比例增益集*，自動調整大小，請要求符合所有規則。

若要描繪出，假設您有下列 4 自動調整大小規則︰

- 如果 CPU < 30%、 縮放比例增益集 1
- 如果記憶體 < 50%，比例增益集 1
- 如果 CPU > 75%，延展 1
- 如果記憶體 > 75%，延展 1

然後遵循就會發生︰

- 如果 CPU 76%，而記憶體會 50%，我們擴充。
- 如果 CPU 50%，而記憶體會 76%我們擴充。

相反地，如果 CPU 25%，而記憶體會 51%自動調整大小會**不**比例增益集。 若要縮放比例中 CPU 必須 29%和記憶體 49%。

### <a name="always-select-a-safe-default-instance-count"></a>請一律先選取 [安全的預設執行個體計數
預設的執行個體計數很重要自動調整大小調整該計算您的服務，當指標無法使用。 因此，選取您的工作負載的安全的預設執行個體數。

### <a name="configure-autoscale-notifications"></a>設定自動調整大小的通知
自動調整大小會通知系統管理員和資源的參與者電子郵件發生下列條件︰

- 自動調整大小服務時採取的動作會失敗。
- 指標無法使用自動調整大小的服務，才能進行縮放比例決策。
- 指標會提供 （復原），以讓小數位數的決策。
除了上述條件，您可以設定電子郵件或 webhook 通知，以取得通知成功的小數位數的動作。
