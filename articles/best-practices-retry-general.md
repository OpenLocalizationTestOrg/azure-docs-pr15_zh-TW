<properties
   pageTitle="再試一次 [一般指示 |Microsoft Azure"
   description="重試暫時性錯誤處理的指南。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="christb"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="07/13/2016"
   ms.author="masashin"/>

# <a name="retry-general-guidance"></a>再試一次 [一般指示

[AZURE.INCLUDE [pnp-header](../includes/guidance-pnp-header-include.md)]

## <a name="overview"></a>概觀

遠端服務與資源進行通訊的所有應用程式必須是區分暫時錯誤。 這是特別是應用程式會在雲端，性質的環境及透過網際網路連線表示這些類型的錯誤的常見更頻繁大小寫。 暫時錯誤包括瞬間遺失的元件和服務的網路連線、 暫時無法使用的服務或忙碌服務時，會發生的逾時。 這些錯誤通常會自行修正，而且如果適當的延遲後重複動作可能會失敗。

這份文件涵蓋暫時性錯誤處理的一般指導的方針。 使用 Microsoft Azure 服務時，處理暫時錯誤的相關資訊，請參閱[Azure 服務特定準則再試一次](best-practices-retry-service-specific.md)。

## <a name="why-do-transient-faults-occur-in-the-cloud"></a>在雲端為什麼發生暫時性錯誤？

在任何環境中，任何平台上的作業系統，並在任何一種應用程式，可以就會發生暫時性錯誤。 在方案中的上執行本機，內部部署基礎結構、 效能及應用程式與元件的可用性通常是透過維護成本和底下常用的硬體重複和元件和資源位關閉每個另一個。 雖然這並不可能失敗，它可以仍產生暫時錯誤-，甚至是透過無法預料的事件，例如外部電源或網路問題或其他損毀狀況中斷。

裝載雲端，包括私人雲端系統，可以使用共用的資源、 重複性、 自動容錯移轉和動態資源分派過大商業運算節點的數字，提供更高的整體可用性。 不過，這些環境的性質，可能表示會比較容易發生暫時性錯誤。 有幾個原因︰

* 共用資源位於雲端環境，並存取這些資源受到才能保護資源節流設定。 載入部分至特定的層級，或達到最大處理量工資率時，若要允許現有要求的處理，並維持為所有使用者服務的效能時，某些服務會拒絕的連線。 若要維持相鄰及使用共用的資源其他租用戶服務的品質會節流幫助。
* 雲端環境是專使用大量的商業硬體單位的數字。 它們動態將載入分散到多個計算單位] 及 [基礎結構元件提供的效能，並提供可靠性自動回收或取代失敗的單位。 此動態性質表示暫時錯誤及暫時性連線失敗可能有時候會出現。
* 通常，還有更多的硬體元件，包括路由器與應用程式及資源與它所使用的服務之間的負載平衡器，例如網路基礎結構。 其他連線延遲和暫時性連線錯誤，有時候可能會導致這個額外的基礎結構。
* 用戶端與伺服器間的網路條件可能會變數，特別是通訊交叉網際網路。 即使是在內部部署的位置，流量幾乎看不太大載入可能會降低通訊和會導致間歇性發生連線失敗。

## <a name="challenges"></a>挑戰
暫時錯誤可以認知應用程式的可用性上安裝龐大的影響，即使其已徹底測試所有可見的情況下。 若要確保可靠作業雲端裝載的應用程式，他們必須能夠回應下列的挑戰︰

* 應用程式必須為能發生，並決定是否有可能為暫時性、 更多長期，這些錯誤時，偵測錯誤或終端機失敗。 其他資源可可能會傳回不同的回應，發生錯誤，並將這些回應也可能會有所不同的作業。例如，從儲存空間閱讀時有錯誤的回應可能不同有錯誤的回應寫入儲存時。 許多資源和服務有制訂暫時性失敗合約。 不過，這類資訊無法使用，可能會很難探索的錯誤和是否有可能暫時性質。
* 應用程式必須能夠重試作業，如果其決定錯誤可能是暫時性及追蹤已重試作業的次數。
* 應用程式必須使用適當的策略重試。 此策略指定的次數，應該再試一次，每次嘗試時，，以及嘗試失敗之後要採取的動作之間的延遲。 嘗試與每一個之間的延遲的適當數目通常是資源的難以判斷，並會根據類型，以及資源和應用程式本身的目前作業系統的狀況而定。

## <a name="general-guidelines"></a>一般指導方針
以下方針可協助您設計適合暫時性錯誤處理機制應用程式︰

* **判斷是否有內建重試機制︰**
  * 多個服務可提供 SDK 或用戶端包含文件庫暫時性錯誤處理機制。 重試原則，它會使用通常被適合的性質和目標服務的需求。 或者，其餘介面服務可能會傳回適當，並等待下次重試嘗試多久重試是否有很有用的資訊。
  * 使用內建重試機制其中之一是可以使用除非您有特定與非常清楚代表不同的重試行為是更適當的需求。
* **判斷適合重試作業時**︰
  * 您應該只再試一次作業，錯誤是暫時 （通常是所示的錯誤），以及是否至少有一些 reattempted 時，操作會成功的機率。 沒有點中重新嘗試表示無效的作業，例如資料庫之作業的更新項目不存在，或要求的服務或發生嚴重錯誤的資源
  * 一般而言，您應該實作重試只可以決定的完整的影響，及位置條件理解，且可以進行驗證。 如果沒有的話，將其保留實作重試呼叫的程式碼。 請記住，資源所傳回的錯誤和您的控制項之外的服務可能會隨著時間，您可能需要重新瀏覽您的暫時性的錯誤偵測邏輯。
  * 當您建立的服務或元件時，請考慮實作錯誤碼與訊息，有助於判斷是否應該再次用戶端無法作業。 特別是，表示在用戶端應該試一次 （可能是藉由傳回**isTransient**值） 和建議之前的下一個重試嘗試適合延遲。 如果您建立 web 服務時，請考慮傳回自訂您的服務合約中定義的錯誤。 即使一般的用戶端可能無法閱讀，它們都很實用的情況，建立自訂的用戶端時。
* **決定適當重試計數與間隔︰**
  * 請務必最佳化重試計數與資料類型的使用案例間隔。 如果您不會重新足夠的次數，應用程式將無法完成這項作業，而且可能會發生錯誤。 如果您再次嘗試太多次，或嘗試之間太短時間間隔，應用程式可能可以按住資源，例如對話、 連線和記憶體長的時間，會影響應用程式的狀況。
  * 時間間隔，嘗試次數適當的值是根據嘗試執行的作業的類型而定。 例如，如果作業是使用者互動的一部分，間隔應該簡短和只幾個重試嘗試避免使用者等待回應 （其中保存開啟連線並降低為其他使用者的可用）。 如果作業的時間有多長執行或重要的工作流程工作的部分取消並重新啟動程序在哪裡昂貴或費時，很適合用於等候再嘗試之間，然後再試一次 [更多的時間。
  * 決定適當重試之間的間隔是最困難設計成功的策略。 一般的策略使用下列類型的重試間隔︰
      * **指數後關閉**。 應用程式會等候一段時間，然後再第一個重試]，並指數增加每一個後續重試之間的時間。 例如，它可能 3 秒，12 秒數，30 秒後再試等等。
      * **遞增的時間間隔**。 應用程式會等候一段時間，然後再第一個重試]，並從屬參照增加每一個後續重試之間的時間。 例如，它可能 3 秒，7 的秒數，13 秒後再試等等。
      * **定期間隔**。 應用程式會等待的每一次嘗試之間的時間。 例如，它可能試每 3 秒。
      * **即時運算再試一次**。 有時候暫時性錯誤是太簡短，或許所造成的事件，例如網路封包衝突] 或 [特殊圖文集硬體元件。 在此情況下，立即重試作業是適當因為可能會成功如果故障已清除的組合，並傳送下一個要求的應用程式的時間。 不過，永遠不應該有一個以上的立即重試次嘗試時，而且您應切換至不同的策略，例如指數後關閉] 或 [後援動作]，如果無法立即重試。
      * **隨機**。 重試策略上述任一可能包含隨機以防止傳送一次後續嘗試的用戶端的多個執行個體。 例如，一個執行個體可能再試一後 3 秒、 11 秒、 28 的秒數，等時另一個執行個體可能試 4 秒鐘之後，12 秒數，26 的秒數，依此類推。 隨機技術很實用的可以結合使用其他策略。  
  * 為一般指導方針，使用指數返回關閉策略背景作業和立即或定期間隔重試策略互動式作業。 在這兩種情況下，您應該選擇延遲而重試計數，好讓所有的最大的延遲再試一次嘗試是內所需的端對端延遲需求。
  * 考慮所有因素重試作業的整體最大逾時的組合。 這些因素包括產生回應 （通常是由逾時值在用戶端設定） 連線失敗所需的時間，以及重試及次數的最大值之間的延遲。 所有的時間的總可能會導致時間，尤其是當使用指數延遲策略位置之間的間隔重試成長快速每很大的整體作業。 如果處理程序必須符合特定服務等級協定 (SLA)，請整體作業的時間，包括所有逾時與延遲，必須內的定義在 SLA
  * Over-aggressive 重試策略，其中有太短時間間隔或也可能會重試，可以讓目標資源或服務上的產生負面影響。 這可能會防止服務的資源復原多載的狀態，並會繼續封鎖或拒絕要求。 此位置多邀請會傳送至] 資源或服務，因此可復原 vicious 圓圈中的結果減少。
  * 一項作業逾時考慮選擇重試間隔]，以避免啟動後續嘗試立即 （例如，類似於重試間隔的逾時）。 也請考慮是否您要保留的總可能期間 （逾時加上重試間隔） 至特定的總時間] 下方。 有異常短或很長的逾時的作業可能會影響多久來等待，以及如何通常試一次。
  * 使用最佳化間隔和次數的例外狀況、 包含任何資料或錯誤碼和服務，所傳回的郵件類型。 例如，一些例外狀況或錯誤代碼 （例如 HTTP 的程式碼具有重試之後標頭在回應中 503 服務無法使用） 可能都會指出錯誤可能會持續時間，或服務失敗而不會回應任何後續嘗試。
* **避免模式**︰
  * 在大部分的情況下，您應避免實作包含重複的圖層的重試程式碼。 設計，包括階層式重試]，或實作重試]，在每個階段的作業，包括階層的要求，除非您有特定的需求，視需要避免此問題。 在下列例外的情況下，使用原則防止重試與延遲期間過多的數字，請確定您瞭解結果。 例如，如果到另一個元件提出要求時，目標服務，並實作重試算三個會有兩個電話哪些然後存取九再試一次嘗試總計，對服務。 許多服務和資源實作內建重試機制，您應該調查如何停用或修改這，如果您需要實作較高層級的重試。
  *  永不實作無限重試機制。 這是可能會防止復原超量的狀況的情況下，從服務的資源，及導致節流，並拒絕繼續較長的連線。 使用以數字或重試，或是實作模式，例如[電路分隔](http://msdn.microsoft.com/library/dn589784.aspx)允許要復原的服務。
  * 永遠不會執行立即重試一次。
  * 避免使用一般重試間隔，尤其是存取服務和 Azure 中的資源時，會有大量的重試次數。 最佳方式是這種情況指數返回關閉策略電路相關功能。
  * 避免多個執行個體的相同的用戶端或多個不同的用戶端，在相同的時間傳送重試執行個體。 如果這是可能會發生，介紹隨機成重試時間間隔。
* **測試您的重試策略和實作︰**
  * 請確定您完全測試您重試策略實作下的以寬一組的情況下可能的話，尤其是同時應用程式和目標資源或服務，它會使用可在非常負載。 若要查看行為於測試期間，您可以︰
      * 插入服務暫時性和非暫時性錯誤。 無效的要求，例如傳送或新增測試要求與回應不同類型的錯誤偵測到的程式碼。 範例使用 TestApi，請參閱[故障 TestApi 測試注入](http://msdn.microsoft.com/magazine/ff898404.aspx)和[簡介 TestApi – 第 5 部分︰ Managed 程式碼錯誤注入 Api](http://blogs.msdn.com/b/ivo_manolov/archive/2009/11/25/9928447.aspx)。
      * 建立 mock 資源或服務會傳回一系列的真實的服務，可能會傳回錯誤。 請確定您涵蓋所有類型的錯誤重試策略是設計用來偵測。
      * 強制暫時停用或服務超載，如果您已建立並部署自訂服務發生暫時性錯誤 （您不應，當然，嘗試超載共用的資源或共用中 Azure 服務）。
      * HTTP 為基礎的 Api，請考慮使用自動化測試 FiddlerCore 文件庫新增額外的來回時間，或變更 （例如 HTTP 狀態碼、 標題、 本文或其他因素） 回應變更 HTTP 要求的結果。 這可讓子集的失敗條件，確定測試是否暫時性錯誤或其他類型的錯誤。 如需詳細資訊，請參閱[FiddlerCore](http://www.telerik.com/fiddler/fiddlercore)。 如需如何使用文件庫，特別是**HttpMangler**類別中的範例檢查[Azure 儲存體 SDK 的程式碼](https://github.com/Azure/azure-storage-net/tree/master/Test)。
      * 執行高負載因子變異數，並且同時測試，以確保重試機制，並且在這些情況下正確的策略運作並不會產生負面影響的用戶端作業或導致跨-污染要求之間。
* **管理重試原則設定︰**
  * _原則再試一次_為所有重試策略的項目組合。 它會定義判斷是否有錯誤可能會暫時，偵測機制使用 （例如標準、 指數返回關閉，及隨機） 的實際的間隔時間值和的次數，再試一次間隔類型。
  * 必須實作重試，甚至是最簡單的應用程式中的許多地方和更複雜的應用程式的每個圖層。 而不是硬式編碼在多個位置的每個原則的項目，請考慮使用中心點儲存所有的原則。 例如，儲存的值，例如間隔與再試一次應用程式的設定檔中的字數統計、 讀取在執行階段，和以程式設計方式建立的重試原則。 如此可讓您更容易管理設定]，並修改和才能回應變更需求和案例微調值。 不過，如果無法從設定取得值，會使用設計系統來儲存的值，而非讀取設定，檔案每次，並確保適合的預設值。
  * Azure 雲端服務應用程式中，請考慮將建立在執行階段服務設定檔中的重試原則，以便進行變更，並不需要重新啟動應用程式所使用的值。
  * 利用內建或預設在用戶端 Api 使用，但只適用於您的狀況，他們所提供的重試策略。 這些策略是通常用途。 在某些情況下，可能是所有必要，但在其他案例他們可能不會提供完整的選項，以符合您特定需求。 您必須瞭解如何設定會影響您的應用程式透過測試判斷最適當的值。
* **登入並追蹤暫時性和非暫時性錯誤︰**
  * 重試策略的一部分，包括例外處理和其他記錄後重的儀器。 雖然偶爾發生暫時性失敗後重試可預期的行為，並不會指出重試問題與一般遞增數字通常是，可能會導致失敗，或為目前影響應用程式的效能與可用性問題的指標。
  * 登暫時錯誤警告項目，而不是錯誤的項目，好讓監控系統不會偵測他們可能會觸發 false 通知的應用程式錯誤。
  * 請考慮將值儲存在您的記錄項目，指出如果重試已由節流在服務中，或造成其他類型的連線失敗次數，例如錯誤，好讓您可以在分析資料的區別它們。 增加節流錯誤的數目，通常會切換至進階版服務，提供專用的硬體需求或應用程式中的設計錯誤的指標。  
  * 請考慮測量和記錄包含重試機制作業所需的整體時間。 這是效果的使用者回應時間、 程序延遲和效率的應用程式的使用情況下是效果的很好的指標的暫時性錯誤的整體。 也記錄次數發生，以瞭解合著的回應時間的因素。
  * 請考慮實作遙測並監控系統可引發的數字時的通知及率的失敗次數]、 [平均次數，或增加整體順利完成，作業所需的時間。
* **管理持續失敗的作業︰**
  * 會有各種情況下位置操作還是會在每次嘗試時，失敗，請務必考慮如何處理這種情況︰
      * 雖然重試策略會定義作業應該重試次數上限，它不會阻止使用相同的次數重複作業，應用程式。 比方說，如果順序處理服務失敗，會將其放登出動作永久嚴重錯誤，請重試策略可能會偵測連線逾時，並將其視為暫時性錯誤以。 程式碼會試一次指定的次數，然後提供。 不過，當另一位客戶訂單，操作會嘗試再次-即使是確定失敗每次。
      * 若要防止連續重試持續失敗的作業，請考慮實作[電路分隔圖樣](http://msdn.microsoft.com/library/dn589784.aspx)。 在此模式中，如果指定的時間範圍內的失敗次數超過閥值，要求會傳回給呼叫者立即為錯誤，而不會在嘗試存取失敗的資源或服務。
      * 應用程式，可以定期測試間歇性與很長的時間間隔之間要求，偵測何時可供使用的服務。 在適當的間隔取決於作業的嚴重性等服務，性質的案例中，而且可能任何項目之間幾分鐘的時間和幾個小時。 測試成功的位置的點，在應用程式，可以繼續正常作業並傳遞至新復原服務的要求。
      * 同時，可能要改為另一個執行個體的服務 （例如在不同的資料中心或應用程式中）、 使用一個類似的服務，提供相容 （可能是較簡單） 的功能，或執行某些替代作業的服務就會變成可用推出，希望。 例如，可能很適合用於在佇列中儲存的服務要求或資料儲存和重新執行這些更新版本。 否則您可以將使用者導向至替代應用程式的執行個體、 降低應用程式的效能，但仍可提供可接受的功能，或只傳回的訊息指出使用者的應用程式不是在進行簡報。

* **其他考量**
  * 決定時次數的值和重試間隔的原則，請考慮如果上的服務或資源的操作是長或多重步驟操作的一部分。 可能很難或昂貴若要將所有的其他操作步驟有已成功，一個時失敗。 在此情況下，很長的時間間隔和大次數可以接受，只要不會封鎖其他作業拿著或鎖定不足的資源。
  * 請考慮重試相同的作業可能會導致不一致的資料。 如果重複多重步驟的程序的某些部分，而且作業不冪，它可能會導致不一致的情形。 例如，作業的遞增的值，如果重複出現，會產生無效的結果。 重複傳送郵件給佇列中的作業可能會導致不一致的訊息消費者如果其無法偵測到重複的訊息。 若要避免此問題，請確定您設計每一個步驟，為冪等作業。 如需有關等冪性的詳細資訊，請參閱[等冪性模式](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)。
  * 請考慮將重試的作業的範圍。 例如，可能會更易於實作重試程式碼，包含數個作業，層級並再試一次全部如果其中一個失敗。 不過，執行此動作可能會導致等冪性問題或不必要的復原作業。
  * 如果您選擇重試範圍包含數個作業，請考慮所有時監視的時間，決定重試間隔，以及失敗通知前的延遲總計。
  * 請考慮如何重試策略可能會影響其他例項並共用的應用程式中，或是其他租用戶時使用共用的資源和服務。 積極重試原則可能會導致這些其他使用者和共用資源和服務的應用程式發生暫時性錯誤的遞增數字。 同樣地，您的應用程式可能會受到實作由其他使用者的資源和服務的重試原則。 重要的應用程式，您可能決定要使用未共用的進階版服務。 可讓您更多控制的載入和連續節流這些資源和服務的其他成本可以幫助。

## <a name="more-information"></a>詳細資訊

* [Azure 服務特定重試指導方針](best-practices-retry-service-specific.md)
* [暫時錯誤處理應用程式區塊](http://msdn.microsoft.com/library/hh680934.aspx)
* [電路分隔圖樣](http://msdn.microsoft.com/library/dn589784.aspx)
* [補償交易圖樣](http://msdn.microsoft.com/library/dn589804.aspx)
* [等冪性模式](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)
